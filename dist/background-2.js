LavaPack.loadBundle([[2496,{"../fsm.cjs":2478,"../logging.cjs":2485,"../utils.cjs":2509,"./Timer.cjs":2497,"./constants.cjs":2498,"./location/index.cjs":2501,"./registry/index.cjs":2505,"./selectors.cjs":2508,"@metamask/base-controller":1203,"@metamask/permission-controller":2297,"@metamask/rpc-errors":2421,"@metamask/snaps-rpc-methods":2543,"@metamask/snaps-sdk":2599,"@metamask/snaps-utils":2713,"@metamask/utils":2835,"@xstate/fsm":3303,"async-mutex":3618,nanoid:4749,semver:5283},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){function s(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var s=n.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t,n){i(e,t),t.set(e,n)}function i(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function r(e,t){return e.get(c(e,t))}function o(e,t,n){return e.set(c(e,t),n),n}function c(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}Object.defineProperty(n,"__esModule",{value:!0}),n.SnapController=n.SNAP_APPROVAL_RESULT=n.SNAP_APPROVAL_UPDATE=n.SNAP_APPROVAL_INSTALL=n.controllerName=void 0;const l=e("@metamask/base-controller"),u=e("@metamask/permission-controller"),d=e("@metamask/rpc-errors"),p=e("@metamask/snaps-rpc-methods"),h=e("@metamask/snaps-sdk"),m=e("@metamask/snaps-utils"),f=e("@metamask/utils"),g=e("@xstate/fsm"),y=e("async-mutex"),S=e("nanoid"),v=e("semver"),b=e("./constants.cjs"),T=e("./location/index.cjs"),w=e("./registry/index.cjs"),_=e("./selectors.cjs"),E=e("./Timer.cjs"),k=e("../fsm.cjs"),P=e("../logging.cjs"),A=e("../utils.cjs");n.controllerName="SnapController",n.SNAP_APPROVAL_INSTALL="wallet_installSnap",n.SNAP_APPROVAL_UPDATE="wallet_updateSnap",n.SNAP_APPROVAL_RESULT="wallet_installSnapResult";const C=new Set(["initialPermissions","id","version","enabled","blocked"]),I={snaps:{},snapStates:{},unencryptedSnapStates:{}};function M(e){return Object.keys(e).reduce((t,n)=>(C.has(n)&&(t[n]=e[n]),t),{})}var R=new WeakMap,O=new WeakMap,N=new WeakMap,x=new WeakMap,D=new WeakMap,j=new WeakMap,L=new WeakMap,F=new WeakMap,H=new WeakMap,$=new WeakMap,B=new WeakMap,U=new WeakMap,V=new WeakMap,q=new WeakMap,W=new WeakMap,G=new WeakMap,z=new WeakMap,Y=new WeakMap,K=new WeakMap,J=new WeakMap,X=new WeakSet,Z=new WeakMap;class Q extends l.BaseController{constructor({closeAllConnections:e,messenger:t,state:l,dynamicPermissions:u=["eth_accounts"],environmentEndowmentPermissions:d=[],excludedPermissions:p={},idleTimeCheckInterval:g=(0,f.inMilliseconds)(5,f.Duration.Second),maxIdleTime:y=(0,f.inMilliseconds)(30,f.Duration.Second),maxRequestTime:S=(0,f.inMilliseconds)(60,f.Duration.Second),fetchFunction:v=globalThis.fetch.bind(undefined),featureFlags:w={},detectSnapLocation:_=T.detectSnapLocation,preinstalledSnaps:E=null,encryptor:k,getMnemonicSeed:P,getFeatureFlags:C=()=>({}),clientCryptography:M,trackEvent:Q}){var ae,ie,re;super({messenger:t,metadata:{snapStates:{persist:!0,anonymous:!1},unencryptedSnapStates:{persist:!0,anonymous:!1},snaps:{persist:e=>Object.values(e).filter(e=>e.status!==m.SnapStatus.Installing).map(e=>({...e,status:m.SnapStatus.Stopped})).reduce((e,t)=>(e[t.id]=t,e),{}),anonymous:!1}},name:n.controllerName,state:{...I,...l}}),i(ie=this,re=X),re.add(ie),a(this,R,void 0),a(this,O,void 0),a(this,N,void 0),a(this,x,void 0),a(this,D,void 0),a(this,j,void 0),a(this,L,void 0),a(this,F,void 0),s(this,"maxRequestTime",void 0),a(this,H,void 0),a(this,$,void 0),a(this,B,void 0),a(this,U,void 0),a(this,V,void 0),a(this,q,void 0),a(this,W,void 0),a(this,G,void 0),a(this,z,void 0),a(this,Y,void 0),a(this,K,void 0),a(this,J,void 0),a(this,Z,(0,A.debouncePersistState)((e,t,n)=>{c(X,this,Ge).call(this,e).stateMutex.runExclusive(async()=>{const s=await c(X,this,ge).call(this,e,t,n);return n?this.update(t=>{t.snapStates[e]=s}):this.update(t=>{t.unencryptedSnapStates[e]=s})}).catch(m.logError)},b.STATE_DEBOUNCE_TIMEOUT)),o(R,this,e),o(O,this,u),o(N,this,d),o(x,this,p),o(D,this,w),o(j,this,v),o(L,this,g),o(F,this,y),this.maxRequestTime=S,o(V,this,_),o(H,this,k),o($,this,P),o(B,this,C),o(U,this,M),o(Y,this,E),this._onUnhandledSnapError=this._onUnhandledSnapError.bind(this),this._onOutboundRequest=this._onOutboundRequest.bind(this),this._onOutboundResponse=this._onOutboundResponse.bind(this),o(W,this,new Map),o(q,this,new Map),o(K,this,Q),c(X,this,se).call(this),this.messagingSystem.subscribe("ExecutionService:unhandledError",this._onUnhandledSnapError),this.messagingSystem.subscribe("ExecutionService:outboundRequest",this._onOutboundRequest),this.messagingSystem.subscribe("ExecutionService:outboundResponse",this._onOutboundResponse),this.messagingSystem.subscribe("SnapController:snapInstalled",({id:e},t)=>{c(X,this,tt).call(this,t,e,m.HandlerType.OnInstall).catch(t=>{(0,m.logError)(`Error when calling \`onInstall\` lifecycle hook for snap "${e}": ${(0,h.getErrorMessage)(t)}`)})}),this.messagingSystem.subscribe("SnapController:snapUpdated",({id:e},t,n)=>{c(X,this,tt).call(this,n,e,m.HandlerType.OnUpdate).catch(t=>{(0,m.logError)(`Error when calling \`onUpdate\` lifecycle hook for snap "${e}": ${(0,h.getErrorMessage)(t)}`)})}),this.messagingSystem.subscribe("KeyringController:lock",c(X,this,nt).bind(this)),c(X,this,ee).call(this),c(X,this,te).call(this),Object.values((null===(ae=this.state)||void 0===ae?void 0:ae.snaps)??{}).forEach(e=>c(X,this,ze).call(this,e.id)),r(Y,this)&&c(X,this,ne).call(this,r(Y,this)),o(J,this,(0,A.throttleTracking)((e,t,n,s)=>{const a=this.messagingSystem.call("SnapsRegistry:getMetadata",e);r(K,this).call(this,{event:"Snap Export Used",category:"Snaps",properties:{snap_id:e,export:t,snap_category:null==a?void 0:a.category,success:n,origin:s}})}))}init(){c(X,this,et).call(this,b.METAMASK_ORIGIN,m.HandlerType.OnStart)}async updateBlockedSnaps(){c(X,this,ce).call(this),await this.messagingSystem.call("SnapsRegistry:update");const e=await this.messagingSystem.call("SnapsRegistry:get",Object.values(this.state.snaps).reduce((e,t)=>(e[t.id]={version:t.version,checksum:t.manifest.source.shasum},e),{}));await Promise.all(Object.entries(e).map(async([e,{status:t,reason:n}])=>t===w.SnapsRegistryStatus.Blocked?c(X,this,ae).call(this,e,n):c(X,this,ie).call(this,e)))}_onUnhandledSnapError(e,t){(0,m.logError)(`Unhandled error from "${e}":`,t),this.stopSnap(e,m.SnapStatusEvents.Crash).catch(e=>{(0,m.logError)(e)})}_onOutboundRequest(e){const t=c(X,this,Ge).call(this,e);t.pendingInboundRequests.filter(e=>"running"===e.timer.status).forEach(e=>e.timer.pause()),t.pendingOutboundRequests+=1}_onOutboundResponse(e){const t=c(X,this,Ge).call(this,e);t.pendingOutboundRequests-=1,0===t.pendingOutboundRequests&&t.pendingInboundRequests.filter(e=>"paused"===e.timer.status).forEach(e=>e.timer.resume())}async startSnap(e){c(X,this,ce).call(this);const t=this.state.snaps[e];if(!t.enabled)throw new Error(`Snap "${e}" is disabled.`);await c(X,this,ke).call(this,{snapId:e,sourceCode:t.sourceCode})}enableSnap(e){if(this.getExpect(e),this.state.snaps[e].blocked)throw new Error(`Snap "${e}" is blocked and cannot be enabled.`);this.update(t=>{t.snaps[e].enabled=!0}),this.messagingSystem.publish("SnapController:snapEnabled",this.getTruncatedExpect(e))}async disableSnap(e){if(!this.has(e))throw new Error(`Snap "${e}" not found.`);this.update(t=>{t.snaps[e].enabled=!1}),this.isRunning(e)&&await this.stopSnap(e,m.SnapStatusEvents.Stop),this.messagingSystem.publish("SnapController:snapDisabled",this.getTruncatedExpect(e))}async stopSnap(e,t=m.SnapStatusEvents.Stop){const n=c(X,this,We).call(this,e);if(!n)throw new Error(`The snap "${e}" is not running.`);if(n.stopPromise)return void await n.stopPromise;const{promise:s,resolve:a}=(0,f.createDeferredPromise)();n.stopPromise=s;try{var i;if(this.isRunning(e))null===(i=r(R,this))||void 0===i||i.call(this,e),await c(X,this,de).call(this,e)}finally{n.lastRequest=null,n.pendingInboundRequests=[],n.pendingOutboundRequests=0,n.stopPromise=null,this.isRunning(e)&&c(X,this,ue).call(this,e,t),a()}}async stopAllSnaps(e=m.SnapStatusEvents.Stop){const t=Object.values(this.state.snaps).filter(e=>this.isRunning(e.id)).map(async t=>this.stopSnap(t.id,e));await Promise.allSettled(t)}isRunning(e){return"running"===this.getExpect(e).status}has(e){return Boolean(this.get(e))}get(e){return this.state.snaps[e]}getExpect(e){const t=this.get(e);return(0,f.assert)(t!==undefined,new Error(`Snap "${e}" not found.`)),t}getTruncated(e){const t=this.get(e);return t?M(t):null}getTruncatedExpect(e){return M(this.getExpect(e))}async updateSnapState(e,t,n){const s=c(X,this,Ge).call(this,e);n?s.state=t:s.unencryptedState=t,r(Z,this).call(this,e,t,n)}clearSnapState(e,t){const n=c(X,this,Ge).call(this,e);t?n.state=null:n.unencryptedState=null,r(Z,this).call(this,e,null,t)}async getSnapState(e,t){const n=c(X,this,Ge).call(this,e);return await n.getStateMutex.runExclusive(async()=>{const s=t?n.state:n.unencryptedState;if(s!==undefined)return s;const a=t?this.state.snapStates[e]:this.state.unencryptedSnapStates[e];if(null===a||a===undefined)return null;if(!t){const e=JSON.parse(a);return n.unencryptedState=e,e}const i=await c(X,this,me).call(this,e,a);return n.state=i,i})}async getSnapFile(e,t,n=h.AuxiliaryFileEncoding.Base64){var s;const a=this.getExpect(e),i=(0,m.normalizeRelative)(t),r=null===(s=a.auxiliaryFiles)||void 0===s||null===(s=s.find(e=>e.path===i))||void 0===s?void 0:s.value;if(!r)return null;const o=await(0,m.encodeAuxiliaryFile)(r,n);return(0,f.assert)(o.length<m.MAX_FILE_SIZE,`Failed to encode static file to "${n}": Static files must be less than 64 MB when encoded.`),o}isMinimumPlatformVersion(e,t){const n=this.getExpect(e),{platformVersion:s}=n.manifest;return!!s&&(0,v.gte)(s,t)}async clearState(){const e=Object.keys(this.state.snaps);await this.stopAllSnaps(),e.forEach(e=>c(X,this,be).call(this,e)),this.update(e=>{e.snaps={},e.snapStates={},e.unencryptedSnapStates={}}),r(q,this).clear(),r(W,this).clear(),r(Y,this)&&c(X,this,ne).call(this,r(Y,this))}async removeSnap(e){return this.removeSnaps([e])}async removeSnaps(e){if(!Array.isArray(e))throw new Error("Expected array of snap ids.");e.forEach(e=>{const t=this.getExpect(e);(0,f.assert)(!1!==t.removable,`${e} is not removable.`)}),await Promise.all(e.map(async e=>{const t=this.getExpect(e),n=this.getTruncatedExpect(e);await this.disableSnap(e),c(X,this,be).call(this,e),c(X,this,ve).call(this,e),r(q,this).delete(e),this.update(t=>{delete t.snaps[e],delete t.snapStates[e],delete t.unencryptedSnapStates[e]}),t.status!==m.SnapStatus.Installing&&this.messagingSystem.publish("SnapController:snapUninstalled",n)}))}removeSnapFromSubject(e,t){var n,s;const a=this.messagingSystem.call("PermissionController:getPermissions",e),i=null==a||null===(n=a[p.WALLET_SNAP_PERMISSION_KEY])||void 0===n||null===(n=n.caveats)||void 0===n?void 0:n.find(e=>e.type===m.SnapCaveatType.SnapIds);if(!i)return;if(Boolean(null===(s=i.value)||void 0===s?void 0:s[t])){const n={...i.value};delete n[t],Object.keys(n).length>0?this.messagingSystem.call("PermissionController:updateCaveat",e,p.WALLET_SNAP_PERMISSION_KEY,m.SnapCaveatType.SnapIds,n):this.messagingSystem.call("PermissionController:revokePermissions",{[e]:[p.WALLET_SNAP_PERMISSION_KEY]})}}revokeDynamicSnapPermissions(e,t){(0,f.assert)(t.every(e=>r(O,this).includes(e)),"Non-dynamic permissions cannot be revoked"),this.messagingSystem.call("PermissionController:revokePermissions",{[e]:t})}incrementActiveReferences(e){c(X,this,Ge).call(this,e).activeReferences+=1}decrementActiveReferences(e){const t=c(X,this,Ge).call(this,e);(0,f.assert)(t.activeReferences>0,"SnapController reference management is in an invalid state."),t.activeReferences-=1}getAllSnaps(){return Object.values(this.state.snaps).map(M)}getRunnableSnaps(){return(0,_.getRunnableSnaps)(this.getAllSnaps())}getPermittedSnaps(e){var t;const n=(null===(t=(this.messagingSystem.call("PermissionController:getPermissions",e)??{})[p.WALLET_SNAP_PERMISSION_KEY])||void 0===t||null===(t=t.caveats)||void 0===t||null===(t=t.find(e=>e.type===m.SnapCaveatType.SnapIds))||void 0===t?void 0:t.value)??{};return Object.keys(n).reduce((e,t)=>{const n=this.get(t),s=this.getTruncated(t);return s&&(null==n?void 0:n.status)!==m.SnapStatus.Installing&&(e[t]=s),e},{})}async installSnaps(e,t){c(X,this,ce).call(this);const n={},s=Object.keys(t),a=[],i=[];try{for(const[s,{version:o}]of Object.entries(t)){(0,m.assertIsValidSnapId)(s);const[t,l]=(0,m.resolveVersionRange)(o);if(t)throw d.rpcErrors.invalidParams(`The "version" field must be a valid SemVer version range if specified. Received: "${o}".`);const u=r(V,this).call(this,s,{versionRange:l,fetch:r(j,this),allowLocal:r(D,this).allowLocalSnaps,resolveVersion:async e=>r(D,this).requireAllowlist?await c(X,this,_e).call(this,s,e):e}),p=this.has(s)&&!u.shouldAlwaysReload;if(p&&c(X,this,Qe).call(this,s,l)){const e=this.getExpect(s);a.push({snapId:s,oldVersion:e.version});let t=c(X,this,Be).call(this,s);if(t!==undefined)throw new Error("This snap is already being updated.");t=c(X,this,Ue).call(this,s),t.newVersion=l}else p||i.push(s);n[s]=await this.processRequestedSnap(e,s,u,l)}i.forEach(t=>this.messagingSystem.publish("SnapController:snapInstalled",this.getTruncatedExpect(t),e,!1)),a.forEach(({snapId:t,oldVersion:n})=>this.messagingSystem.publish("SnapController:snapUpdated",this.getTruncatedExpect(t),n,e,!1)),s.forEach(e=>r(W,this).delete(e))}catch(e){const t=i.filter(e=>this.has(e));await this.removeSnaps(t);const n=[...r(W,this).keys()],s=a.map(({snapId:e})=>e).filter(e=>n.includes(e));throw await c(X,this,qe).call(this,s),e}return n}async processRequestedSnap(e,t,s,a){const i=this.getTruncated(t);if(i&&!s.shouldAlwaysReload)return(0,f.satisfiesVersionRange)(i.version,a)?i:await this.updateSnap(e,t,s,a,!1);c(X,this,oe).call(this);let r=c(X,this,Te).call(this,{origin:e,snapId:t,type:n.SNAP_APPROVAL_INSTALL});this.messagingSystem.publish("SnapController:snapInstallStarted",t,e,!1),i&&this.isRunning(t)&&await this.stopSnap(t,m.SnapStatusEvents.Stop),i&&s.shouldAlwaysReload&&c(X,this,be).call(this,t);try{const{sourceCode:i}=await c(X,this,Ee).call(this,{origin:e,id:t,location:s,versionRange:a});await this.authorize(t,r),r=c(X,this,Te).call(this,{origin:e,snapId:t,type:n.SNAP_APPROVAL_RESULT}),await c(X,this,ke).call(this,{snapId:t,sourceCode:i});const o=this.getTruncatedExpect(t);return c(X,this,we).call(this,r.id,{loading:!1,type:n.SNAP_APPROVAL_INSTALL}),o}catch(s){(0,m.logError)(`Error when adding ${t}.`,s);const a=s instanceof Error?s.message:s.toString();throw c(X,this,we).call(this,r.id,{loading:!1,type:n.SNAP_APPROVAL_INSTALL,error:a}),this.messagingSystem.publish("SnapController:snapInstallFailed",t,e,!1,a),s}}async updateSnap(e,t,s,a=m.DEFAULT_REQUESTED_SNAP_VERSION,i=!0){c(X,this,oe).call(this),c(X,this,ce).call(this);const r=this.getExpect(t);if(r.preinstalled)throw new Error("Preinstalled Snaps cannot be manually updated.");if(!(0,f.isValidSemVerRange)(a))throw new Error(`Received invalid snap version range: "${a}".`);let o=c(X,this,Te).call(this,{origin:e,snapId:t,type:n.SNAP_APPROVAL_UPDATE});try{this.messagingSystem.publish("SnapController:snapInstallStarted",t,e,!0);const l=r.manifest,u=await(0,A.fetchSnap)(t,s),{sourceCode:h,manifest:g}=u,y=g.result,S=y.version;if(!(0,f.gtVersion)(S,r.version))throw d.rpcErrors.invalidParams(`Snap "${t}@${r.version}" is already installed. Couldn't update to a version inside requested "${a}" range.`);if(!(0,f.satisfiesVersionRange)(S,a))throw new Error(`Version mismatch. Manifest for "${t}" specifies version "${S}" which doesn't satisfy requested version range "${a}".`);await c(X,this,re).call(this,t,{version:S,checksum:y.source.shasum,permissions:y.initialPermissions,platformVersion:y.platformVersion});const v=(0,p.processSnapPermissions)(y.initialPermissions);c(X,this,Ce).call(this,v);const{newPermissions:b,unusedPermissions:T,approvedPermissions:w}=c(X,this,Ye).call(this,t,v),{newConnections:_,unusedConnections:E,approvedConnections:k}=c(X,this,Je).call(this,t,l.initialConnections??{},y.initialConnections??{});c(X,this,we).call(this,o.id,{permissions:b,newVersion:y.version,newPermissions:b,approvedPermissions:w,unusedPermissions:T,newConnections:_,unusedConnections:E,approvedConnections:k,loading:!1});const{permissions:P,...C}=await o.promise;o=c(X,this,Te).call(this,{origin:e,snapId:t,type:n.SNAP_APPROVAL_RESULT}),this.isRunning(t)&&await this.stopSnap(t,m.SnapStatusEvents.Stop),c(X,this,ue).call(this,t,m.SnapStatusEvents.Update),c(X,this,Ae).call(this,{origin:e,id:t,files:u,isUpdate:!0}),c(X,this,Ze).call(this,{snapId:t,unusedPermissions:T,newPermissions:P,requestData:C}),y.initialConnections&&c(X,this,ye).call(this,t,l.initialConnections??null,y.initialConnections);const I=c(X,this,Be).call(this,t);I!==undefined&&(I.permissions.revoked=T,I.permissions.granted=P,I.permissions.requestData=C);const M=h.toString();(0,f.assert)("string"==typeof M&&M.length>0,`Invalid source code for snap "${t}".`);try{await c(X,this,ke).call(this,{snapId:t,sourceCode:M})}catch{throw new Error(`Snap ${t} crashed with updated source code.`)}const R=this.getTruncatedExpect(t);return i&&this.messagingSystem.publish("SnapController:snapUpdated",R,r.version,e,!1),c(X,this,we).call(this,o.id,{loading:!1,type:n.SNAP_APPROVAL_UPDATE}),R}catch(s){(0,m.logError)(`Error when updating ${t},`,s);const a=s instanceof Error?s.message:s.toString();throw c(X,this,we).call(this,o.id,{loading:!1,error:a,type:n.SNAP_APPROVAL_UPDATE}),this.messagingSystem.publish("SnapController:snapInstallFailed",t,e,!0,a),s}}async authorize(e,t){(0,P.log)(`Authorizing snap: ${e}`);const n=this.state.snaps[e],{initialPermissions:s,initialConnections:a}=n;try{const i=(0,p.processSnapPermissions)(s);c(X,this,Ce).call(this,i),c(X,this,we).call(this,t.id,{loading:!1,connections:a??{},permissions:i});const{permissions:r,...o}=await t.promise;c(X,this,Ze).call(this,{snapId:e,newPermissions:r,requestData:o}),n.manifest.initialConnections&&c(X,this,ye).call(this,e,null,n.manifest.initialConnections)}finally{c(X,this,Ge).call(this,e).installPromise=null}}destroy(){super.destroy(),r(G,this)&&clearTimeout(r(G,this)),this.messagingSystem.unsubscribe("ExecutionService:unhandledError",this._onUnhandledSnapError),this.messagingSystem.unsubscribe("ExecutionService:outboundRequest",this._onOutboundRequest),this.messagingSystem.unsubscribe("ExecutionService:outboundResponse",this._onOutboundResponse),this.messagingSystem.clearEventSubscriptions("SnapController:snapInstalled"),this.messagingSystem.clearEventSubscriptions("SnapController:snapUpdated")}async handleRequest({snapId:e,origin:t,handler:n,request:s}){c(X,this,ce).call(this),(0,f.assert)(t===b.METAMASK_ORIGIN||(0,m.isValidUrl)(t),"'origin' must be a valid URL or 'metamask'.");const a={jsonrpc:"2.0",id:(0,S.nanoid)(),...s};(0,f.assertIsJsonRpcRequest)(a);const i=p.handlerEndowments[n];(0,f.assert)("string"==typeof i||null===i,"'permissionName' must be either a string or null.");const r=this.messagingSystem.call("PermissionController:getPermissions",e);if(!(null===i||r&&(0,f.hasProperty)(r,i)))throw new Error(`Snap "${e}" is not permitted to use "${i}".`);const o=i?r[i]:undefined;if(i===p.SnapEndowments.Rpc||i===p.SnapEndowments.Keyring){(0,f.assert)(o);const n=this.messagingSystem.call("SubjectMetadataController:getSubjectMetadata",t),s=i===p.SnapEndowments.Rpc?(0,p.getRpcCaveatOrigins)(o):(0,p.getKeyringCaveatOrigins)(o);if((0,f.assert)(s),!(0,m.isOriginAllowed)(s,(null==n?void 0:n.subjectType)??u.SubjectType.Website,t))throw new Error(`Snap "${e}" is not permitted to handle requests from "${t}".`)}if(t!==b.METAMASK_ORIGIN&&b.CLIENT_ONLY_HANDLERS.includes(n))throw new Error(`"${n}" can only be invoked by MetaMask.`);if(!this.state.snaps[e].enabled)throw new Error(`Snap "${e}" is disabled.`);if(this.state.snaps[e].status===m.SnapStatus.Installing)throw new Error(`Snap "${e}" is currently being installed. Please try again later.`);const l=c(X,this,Me).call(this,o),d=c(X,this,Ge).call(this,e);if(d.stopPromise&&await d.stopPromise,!this.isRunning(e)){d.startPromise||(d.startPromise=this.startSnap(e));try{await d.startPromise}finally{d.startPromise=null}}const h=c(X,this,Le).call(this,e,n,a),g=new E.Timer(l);c(X,this,He).call(this,e,h.id,g);const y=this.messagingSystem.call("ExecutionService:handleRpcRequest",e,{origin:t,handler:n,request:h});try{const s=await(0,A.withTimeout)(y,g);if(s===A.hasTimedOut){const t=null!==d.stopPromise||!this.isRunning(e);throw new Error(t?`${e} was stopped and the request was cancelled. This is likely because the Snap crashed.`:`${e} failed to respond to the request in time.`)}await c(X,this,Fe).call(this,e,n,s);const a=await c(X,this,Ne).call(this,e,n,h,s);return c(X,this,$e).call(this,e,h.id,n,t,!0),a}catch(s){c(X,this,$e).call(this,e,h.id,n,t,!1);const[a,i]=(0,m.unwrapError)(s),r=null!==d.stopPromise||!this.isRunning(e);throw i||(r||(0,m.logError)(`"${e}" crashed due to an unhandled error:`,a),await this.stopSnap(e,m.SnapStatusEvents.Crash)),a}}setClientActive(e){e?c(X,this,et).call(this,b.METAMASK_ORIGIN,m.HandlerType.OnActive):c(X,this,et).call(this,b.METAMASK_ORIGIN,m.HandlerType.OnInactive)}}function ee(){const e=({snapId:e})=>this.getExpect(e).enabled,t={initial:m.SnapStatus.Installing,states:{[m.SnapStatus.Installing]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:e}}},[m.SnapStatus.Updating]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:e},[m.SnapStatusEvents.Stop]:m.SnapStatus.Stopped}},[m.SnapStatus.Running]:{on:{[m.SnapStatusEvents.Stop]:m.SnapStatus.Stopped,[m.SnapStatusEvents.Crash]:m.SnapStatus.Crashed}},[m.SnapStatus.Stopped]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:e},[m.SnapStatusEvents.Update]:m.SnapStatus.Updating}},[m.SnapStatus.Crashed]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:e},[m.SnapStatusEvents.Update]:m.SnapStatus.Updating}}}};o(z,this,(0,g.createMachine)(t)),(0,k.validateMachine)(r(z,this))}function te(){this.messagingSystem.registerActionHandler(`${n.controllerName}:init`,(...e)=>this.init(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:clearSnapState`,(...e)=>this.clearSnapState(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:get`,(...e)=>this.get(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:getSnapState`,async(...e)=>this.getSnapState(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:handleRequest`,async(...e)=>this.handleRequest(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:has`,(...e)=>this.has(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:updateBlockedSnaps`,async()=>this.updateBlockedSnaps()),this.messagingSystem.registerActionHandler(`${n.controllerName}:updateSnapState`,async(...e)=>this.updateSnapState(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:enable`,(...e)=>this.enableSnap(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:disable`,async(...e)=>this.disableSnap(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:remove`,async(...e)=>this.removeSnap(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:getPermitted`,(...e)=>this.getPermittedSnaps(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:install`,async(...e)=>this.installSnaps(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:getAll`,(...e)=>this.getAllSnaps(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:getRunnableSnaps`,(...e)=>this.getRunnableSnaps(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:incrementActiveReferences`,(...e)=>this.incrementActiveReferences(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:decrementActiveReferences`,(...e)=>this.decrementActiveReferences(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:disconnectOrigin`,(...e)=>this.removeSnapFromSubject(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:revokeDynamicPermissions`,(...e)=>this.revokeDynamicSnapPermissions(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:getFile`,async(...e)=>this.getSnapFile(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:stopAllSnaps`,async(...e)=>this.stopAllSnaps(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:isMinimumPlatformVersion`,(...e)=>this.isMinimumPlatformVersion(...e)),this.messagingSystem.registerActionHandler(`${n.controllerName}:setClientActive`,(...e)=>this.setClientActive(...e))}function ne(e){for(const{snapId:n,manifest:s,files:a,removable:i,hidden:r,hideSnapBranding:o}of e){var t;const e=this.get(n),l=e!==undefined,u=l&&(0,f.gtVersion)(s.version,e.version);if(l&&(!u||!0!==e.preinstalled))continue;const d=new m.VirtualFile({path:m.NpmSnapFileNames.Manifest,value:JSON.stringify(s),result:s}),h=a.map(({path:e,value:t})=>new m.VirtualFile({value:t,path:e})),{filePath:g,iconPath:y}=s.source.location.npm,S=h.find(e=>e.path===g),v=y?h.find(e=>e.path===y):undefined;(0,f.assert)(S,"Source code not provided for preinstalled snap."),(0,f.assert)(!y||y&&v,"Icon not provided for preinstalled snap."),(0,f.assert)(s.source.files===undefined,"Auxiliary files are not currently supported for preinstalled snaps.");const T=(null===(t=s.source.locales)||void 0===t?void 0:t.map(e=>h.find(t=>t.path===e)))??[],w=(0,m.getValidatedLocalizationFiles)(T.filter(Boolean));(0,f.assert)(T.length===w.length,"Missing localization files for preinstalled snap.");const _={manifest:d,sourceCode:S,svgIcon:v,auxiliaryFiles:[],localizationFiles:w};c(X,this,Ae).call(this,{id:n,origin:b.METAMASK_ORIGIN,files:_,removable:i,hidden:r,hideSnapBranding:o,preinstalled:!0});const E=(0,p.processSnapPermissions)(s.initialPermissions);c(X,this,Ce).call(this,E);const{newPermissions:k,unusedPermissions:P}=c(X,this,Ye).call(this,n,E);c(X,this,Ze).call(this,{snapId:n,newPermissions:k,unusedPermissions:P}),s.initialConnections&&c(X,this,ye).call(this,n,(null==e?void 0:e.initialConnections)??null,s.initialConnections),this.update(e=>{e.snaps[n].status=m.SnapStatus.Stopped}),c(X,this,ze).call(this,n),u?this.messagingSystem.publish("SnapController:snapUpdated",this.getTruncatedExpect(n),e.version,b.METAMASK_ORIGIN,!0):this.messagingSystem.publish("SnapController:snapInstalled",this.getTruncatedExpect(n),b.METAMASK_ORIGIN,!0)}}function se(){o(G,this,setTimeout(()=>{c(X,this,le).call(this).catch(e=>{(0,m.logError)(e)}),c(X,this,se).call(this)},r(L,this)))}async function ae(e,t){if(this.has(e)){try{this.update(n=>{n.snaps[e].blocked=!0,n.snaps[e].blockInformation=t}),await this.disableSnap(e)}catch(t){(0,m.logError)(`Encountered error when stopping blocked snap "${e}".`,t)}this.messagingSystem.publish(`${n.controllerName}:snapBlocked`,e,t)}}function ie(e){this.has(e)&&this.state.snaps[e].blocked&&(this.update(t=>{t.snaps[e].blocked=!1,delete t.snaps[e].blockInformation}),this.messagingSystem.publish(`${n.controllerName}:snapUnblocked`,e))}async function re(e,{platformVersion:t,...n}){const s=(await this.messagingSystem.call("SnapsRegistry:get",{[e]:n}))[e];var a;if(s.status===w.SnapsRegistryStatus.Blocked)throw new Error(`Cannot install version "${n.version}" of snap "${e}": The version is blocked. ${(null===(a=s.reason)||void 0===a?void 0:a.explanation)??""}`);const i=Object.keys(n.permissions).some(e=>!b.ALLOWED_PERMISSIONS.includes(e));if(r(D,this).requireAllowlist&&i&&s.status!==w.SnapsRegistryStatus.Verified)throw new Error(`Cannot install version "${n.version}" of snap "${e}": ${s.status===w.SnapsRegistryStatus.Unavailable?"The registry is temporarily unavailable.":"The snap is not on the allowlist."}`);c(X,this,Ie).call(this,e,t)}function oe(){(0,f.assert)(!0!==r(D,this).disableSnapInstallation,"Installing Snaps is currently disabled in this version of MetaMask.")}function ce(){const e=r(B,this).call(this);(0,f.assert)(!0!==e.disableSnaps,"The Snaps platform requires basic functionality to be used. Enable basic functionality in the settings to use the Snaps platform.")}async function le(){const e=[...r(q,this).entries()];return Promise.all(e.filter(([e,t])=>0===t.activeReferences&&0===t.pendingInboundRequests.length&&t.lastRequest&&r(F,this)&&(0,f.timeSince)(t.lastRequest)>r(F,this)).map(async([e])=>this.stopSnap(e,m.SnapStatusEvents.Stop)))}function ue(e,t){const{interpreter:n}=c(X,this,Ge).call(this,e);n.send(t),this.update(t=>{t.snaps[e].status=n.state.value})}async function de(e){await this.messagingSystem.call("ExecutionService:terminateSnap",e),await new Promise(e=>setTimeout(e,1));c(X,this,Ge).call(this,e).pendingInboundRequests.filter(e=>"finished"!==e.timer.status).forEach(e=>e.timer.finish()),await new Promise(e=>setTimeout(e,1)),this.messagingSystem.publish("SnapController:snapTerminated",this.getTruncatedExpect(e))}function pe(e,t=c(X,this,Ge).call(this,e)){return null!==t.encryptionKey&&null!==t.encryptionSalt}async function he({snapId:e,salt:t,useCache:n,keyMetadata:s}){const a=c(X,this,Ge).call(this,e);if(c(X,this,pe).call(this,e,a)&&n)return{key:await r(H,this).importKey(a.encryptionKey),salt:a.encryptionSalt};const i=t??r(H,this).generateSalt(),o=await r($,this).call(this),l=await(0,p.getEncryptionEntropy)({snapId:e,seed:o,cryptographicFunctions:r(U,this)}),u=await r(H,this).keyFromPassword(l,i,!0,s),d=await r(H,this).exportKey(u);return n&&(a.encryptionKey=d,a.encryptionSalt=i),{key:u,salt:i}}async function me(e,t){try{const n=JSON.parse(t),{salt:s,keyMetadata:a}=n,i=c(X,this,pe).call(this,e)||r(H,this).isVaultUpdated(t),{key:o}=await c(X,this,he).call(this,{snapId:e,salt:s,useCache:i,keyMetadata:a??b.LEGACY_ENCRYPTION_KEY_DERIVATION_OPTIONS});return await r(H,this).decryptWithKey(o,n)}catch{throw d.rpcErrors.internal({message:"Failed to decrypt snap state, the state must be corrupted."})}}async function fe(e,t){const{key:n,salt:s}=await c(X,this,he).call(this,{snapId:e,useCache:!0}),a=await r(H,this).encryptWithKey(n,t);return a.salt=s,JSON.stringify(a)}async function ge(e,t,n){return null===t?null:n?await c(X,this,fe).call(this,e,t):JSON.stringify(t)}function ye(e,t,n){if(t){const s=(0,A.setDiff)(t,n);for(const t of Object.keys(s))this.removeSnapFromSubject(t,e)}for(const t of Object.keys(n))c(X,this,Se).call(this,t,e)}function Se(e,t){var n,s;const a=this.messagingSystem.call("PermissionController:getPermissions",e),i=null==a||null===(n=a[p.WALLET_SNAP_PERMISSION_KEY])||void 0===n||null===(n=n.caveats)||void 0===n?void 0:n.find(e=>e.type===m.SnapCaveatType.SnapIds);if(Boolean(null==i||null===(s=i.value)||void 0===s?void 0:s[t]))return;if(i)return void this.messagingSystem.call("PermissionController:updateCaveat",e,p.WALLET_SNAP_PERMISSION_KEY,m.SnapCaveatType.SnapIds,{...i.value,[t]:{}});const r={[p.WALLET_SNAP_PERMISSION_KEY]:{caveats:[{type:m.SnapCaveatType.SnapIds,value:{[t]:{}}}]}};this.messagingSystem.call("PermissionController:grantPermissions",{approvedPermissions:r,subject:{origin:e}})}function ve(e){const t=this.messagingSystem.call("PermissionController:getSubjectNames");for(const n of t)this.removeSnapFromSubject(n,e)}function be(e){this.messagingSystem.call("PermissionController:hasPermissions",e)&&this.messagingSystem.call("PermissionController:revokeAllPermissions",e)}function Te({origin:e,snapId:t,type:n}){const s=(0,S.nanoid)();return{id:s,promise:this.messagingSystem.call("ApprovalController:addRequest",{origin:e,id:s,type:n,requestData:{metadata:{id:s,origin:t,dappOrigin:e},snapId:t},requestState:{loading:!0}},!0)}}function we(e,t){try{this.messagingSystem.call("ApprovalController:updateRequestState",{id:e,requestState:t})}catch{}}async function _e(e,t){return await this.messagingSystem.call("SnapsRegistry:resolveVersion",e,t)}async function Ee(e){const{id:t,location:n,versionRange:s}=e;c(X,this,ze).call(this,t);const a=c(X,this,Ge).call(this,t);a.installPromise||((0,P.log)(`Adding snap: ${t}`),a.installPromise=(async()=>{const a=await(0,A.fetchSnap)(t,n),i=a.manifest.result;if(!(0,f.satisfiesVersionRange)(i.version,s))throw new Error(`Version mismatch. Manifest for "${t}" specifies version "${i.version}" which doesn't satisfy requested version range "${s}".`);await c(X,this,re).call(this,t,{version:i.version,checksum:i.source.shasum,permissions:i.initialPermissions,platformVersion:i.platformVersion});const o=r(D,this).forcePreinstalledSnaps&&(0,A.isLocalSnapId)(t)?{preinstalled:!0,hideSnapBranding:!0,hidden:!1}:{};return c(X,this,Ae).call(this,{...e,files:a,id:t,...o})})());try{return await a.installPromise}catch(e){throw a.installPromise=null,e}}async function ke(e){const{snapId:t}=e;if(this.isRunning(t))throw new Error(`Snap "${t}" is already started.`);try{const n=c(X,this,Ge).call(this,t),s=await this.messagingSystem.call("ExecutionService:executeSnap",{...e,endowments:await c(X,this,Pe).call(this,t)});return c(X,this,ue).call(this,t,m.SnapStatusEvents.Start),n.lastRequest=Date.now(),s}catch(e){throw await c(X,this,de).call(this,t),e}}async function Pe(e){let t=[];for(const n of r(N,this))if(this.messagingSystem.call("PermissionController:hasPermission",e,n)){const s=await this.messagingSystem.call("PermissionController:getEndowments",e,n);if(s){if(!Array.isArray(s)||s.some(e=>"string"!=typeof e))throw new Error("Expected an array of string endowment names.");t=t.concat(s)}}const n=[...new Set([...m.DEFAULT_ENDOWMENTS,...t])];return n.length<m.DEFAULT_ENDOWMENTS.length+t.length&&(0,m.logError)(`Duplicate endowments found for ${e}. Default endowments should not be requested.`,t),n}function Ae(e){const{id:t,origin:n,files:s,isUpdate:a=!1,removable:i,preinstalled:o,hidden:l,hideSnapBranding:d}=e,{manifest:p,sourceCode:h,svgIcon:g,auxiliaryFiles:y,localizationFiles:S}=s;(0,m.assertIsSnapManifest)(p.result);const{version:v}=p.result,b=h.toString();(0,f.assert)("string"==typeof b&&b.length>0,`Invalid source code for snap "${t}".`);const T=y.map(e=>((0,f.assert)("string"==typeof e.data.base64),{path:e.path,value:e.data.base64})),w=this.state.snaps[t],_=[...(null==w?void 0:w.versionHistory)??[],{version:v,date:Date.now(),origin:n}],E=S.map(e=>e.result),k={...w,blocked:!1,enabled:!0,removable:i,preinstalled:o,hidden:l,hideSnapBranding:d,id:t,initialConnections:p.result.initialConnections,initialPermissions:p.result.initialPermissions,manifest:p.result,status:r(z,this).config.initial,sourceCode:b,version:v,versionHistory:_,auxiliaryFiles:T,localizationFiles:E};delete k.blockInformation;const{inversePatches:P}=this.update(e=>{e.snaps[t]=k});if(a){const e=c(X,this,Be).call(this,t);e!==undefined&&(e.statePatches=P)}const{proposedName:A}=(0,m.getLocalizedSnapManifest)(p.result,"en",E);return this.messagingSystem.call("SubjectMetadataController:addSubjectMetadata",{subjectType:u.SubjectType.Snap,name:A,origin:k.id,version:v,svgIcon:(null==g?void 0:g.toString())??null}),{...k,sourceCode:b}}function Ce(e){const t=Object.keys(e),n=Array.from(new Set(Object.values(p.handlerEndowments)));(0,f.assert)(t.some(e=>n.includes(e)),`A snap must request at least one of the following permissions: ${n.filter(e=>null!==e).join(", ")}.`);const s=t.reduce((e,t)=>((0,f.hasProperty)(r(x,this),t)&&e.push(r(x,this)[t]),e),[]);(0,f.assert)(0===s.length,`One or more permissions are not allowed:\n${s.join("\n")}`)}function Ie(e,t){if(t!==undefined&&(0,v.gt)(t,(0,m.getPlatformVersion)())){const n=`The Snap "${e}" requires platform version "${t}" which is greater than the current platform version "${(0,m.getPlatformVersion)()}".`;if(r(D,this).rejectInvalidPlatformVersion)throw new Error(n);(0,m.logWarning)(n)}}function Me(e){return(0,p.getMaxRequestTimeCaveat)(e)??this.maxRequestTime}async function Re(e,t,n){return this.messagingSystem.call("SnapInterfaceController:createInterface",e,t,undefined,n)}function Oe(e,t){(0,f.assert)(this.messagingSystem.call("SnapInterfaceController:getInterface",e,t))}async function Ne(e,t,n,s){switch(t){case m.HandlerType.OnTransaction:case m.HandlerType.OnSignature:case m.HandlerType.OnHomePage:case m.HandlerType.OnSettingsPage:{const t=s;if(t&&(0,f.hasProperty)(t,"content")){const{content:n,...s}=t;return{...s,id:await c(X,this,Re).call(this,e,n)}}return s}case m.HandlerType.OnAssetsLookup:return c(X,this,xe).call(this,e,n,s);case m.HandlerType.OnAssetsConversion:return c(X,this,De).call(this,n,s);case m.HandlerType.OnAssetsMarketData:return c(X,this,je).call(this,n,s);default:return s}}function xe(e,{params:t},{assets:n}){const s=this.messagingSystem.call("PermissionController:getPermissions",e);(0,f.assert)(s);const a=s[p.SnapEndowments.Assets],i=(0,p.getChainIdsCaveat)(a);(0,f.assert)(i);const{assets:r}=t;return{assets:Object.keys(n).reduce((e,t)=>{const s=t;return i.some(e=>s.startsWith(e))&&r.includes(s)&&(e[s]=n[s]),e},{})}}function De({params:e},{conversionRates:t}){const{conversions:n}=e;return{conversionRates:n.reduce((e,n)=>{var s;const a=null===(s=t[n.from])||void 0===s?void 0:s[n.to];var i;a&&(e[i=n.from]??(e[i]={}),e[n.from][n.to]=a);return e},{})}}function je({params:e},{marketData:t}){const{assets:n}=e;return{marketData:n.reduce((e,n)=>{var s;const a=null===(s=t[n.asset])||void 0===s?void 0:s[n.unit];var i;a&&(e[i=n.asset]??(e[i]={}),e[n.asset][n.unit]=a);return e},{})}}function Le(e,t,n){if(t===m.HandlerType.OnUserInput){(0,f.assert)(n.params&&(0,f.hasProperty)(n.params,"id"));const t=n.params.id,{context:s}=this.messagingSystem.call("SnapInterfaceController:getInterface",e,t);return{...n,params:{...n.params,context:s}}}return n}async function Fe(e,t,n){switch(t){case m.HandlerType.OnTransaction:(0,f.assertStruct)(n,m.OnTransactionResponseStruct),n&&(0,f.hasProperty)(n,"id")&&c(X,this,Oe).call(this,e,n.id);break;case m.HandlerType.OnSignature:(0,f.assertStruct)(n,m.OnSignatureResponseStruct),n&&(0,f.hasProperty)(n,"id")&&c(X,this,Oe).call(this,e,n.id);break;case m.HandlerType.OnHomePage:(0,f.assertStruct)(n,m.OnHomePageResponseStruct),n&&(0,f.hasProperty)(n,"id")&&c(X,this,Oe).call(this,e,n.id);break;case m.HandlerType.OnSettingsPage:(0,f.assertStruct)(n,m.OnSettingsPageResponseStruct),n&&(0,f.hasProperty)(n,"id")&&c(X,this,Oe).call(this,e,n.id);break;case m.HandlerType.OnNameLookup:(0,f.assertStruct)(n,m.OnNameLookupResponseStruct);break;case m.HandlerType.OnAssetsLookup:(0,f.assertStruct)(n,h.OnAssetsLookupResponseStruct);break;case m.HandlerType.OnAssetsConversion:(0,f.assertStruct)(n,m.OnAssetsConversionResponseStruct);break;case m.HandlerType.OnAssetHistoricalPrice:(0,f.assertStruct)(n,m.OnAssetHistoricalPriceResponseStruct);break;case m.HandlerType.OnAssetsMarketData:(0,f.assertStruct)(n,m.OnAssetsMarketDataResponseStruct)}}function He(e,t,n){const s=c(X,this,Ge).call(this,e);s.pendingInboundRequests.push({requestId:t,timer:n}),s.lastRequest=null}function $e(e,t,n,s,a){const i=c(X,this,Ge).call(this,e);i.pendingInboundRequests=i.pendingInboundRequests.filter(e=>e.requestId!==t),0===i.pendingInboundRequests.length&&(i.lastRequest=Date.now());const o=this.get(e);if((0,A.isTrackableHandler)(n)&&(null==o||!o.preinstalled))try{r(J,this).call(this,e,n,a,s)}catch(e){(0,m.logError)(`Error when calling MetaMetrics hook for snap "${null==o?void 0:o.id}": ${(0,h.getErrorMessage)(e)}`)}}function Be(e){return r(W,this).get(e)}function Ue(e){(0,f.assert)(r(W,this).get(e)===undefined,new Error(`Snap "${e}" rollback snapshot already exists.`)),r(W,this).set(e,{statePatches:[],permissions:{},newVersion:""});const t=r(W,this).get(e);return(0,f.assert)(t!==undefined,new Error(`Snapshot creation failed for ${e}.`)),t}async function Ve(e){var t,n;const s=c(X,this,Be).call(this,e);if(!s)throw new Error("A snapshot does not exist for this snap.");await this.stopSnap(e,m.SnapStatusEvents.Stop),(null===(t=this.get(e))||void 0===t?void 0:t.status)!==m.SnapStatus.Stopped&&c(X,this,ue).call(this,e,m.SnapStatusEvents.Stop);const{statePatches:a,permissions:i}=s;null!=a&&a.length&&this.applyPatches(a),(null===(n=this.get(e))||void 0===n?void 0:n.status)!==m.SnapStatus.Stopped&&this.update(t=>{t.snaps[e].status=m.SnapStatus.Stopped}),c(X,this,Ze).call(this,{snapId:e,unusedPermissions:i.granted,newPermissions:i.revoked,requestData:i.requestData});const o=this.getTruncatedExpect(e);this.messagingSystem.publish("SnapController:snapRolledback",o,s.newVersion),r(W,this).delete(e)}async function qe(e){for(const t of e)await c(X,this,Ve).call(this,t)}function We(e){return r(q,this).get(e)}function Ge(e){const t=c(X,this,We).call(this,e);return(0,f.assert)(t!==undefined,new Error(`Snap "${e}" runtime data not found`)),t}function ze(e){if(r(q,this).has(e))return;const t=this.get(e),n=(0,g.interpret)(r(z,this));n.start({context:{snapId:e},value:(null==t?void 0:t.status)??r(z,this).config.initial}),(0,k.forceStrict)(n),r(q,this).set(e,{lastRequest:null,startPromise:null,stopPromise:null,installPromise:null,encryptionKey:null,encryptionSalt:null,activeReferences:0,pendingInboundRequests:[],pendingOutboundRequests:0,interpreter:n,stateMutex:new y.Mutex,getStateMutex:new y.Mutex})}function Ye(e,t){const n=this.messagingSystem.call("PermissionController:getPermissions",e)??{},s=(0,A.permissionsDiff)(t,n),a=(0,A.permissionsDiff)(n,t);return{newPermissions:s,unusedPermissions:a,approvedPermissions:(0,A.permissionsDiff)(n,a)}}function Ke(e,t){var n,s;const a=this.messagingSystem.call("PermissionController:getPermissions",t),i=null==a||null===(n=a[p.WALLET_SNAP_PERMISSION_KEY])||void 0===n||null===(n=n.caveats)||void 0===n?void 0:n.find(e=>e.type===m.SnapCaveatType.SnapIds);return Boolean(null==i||null===(s=i.value)||void 0===s?void 0:s[e])}function Je(e,t,n){const s=Object.keys(t).filter(t=>c(X,this,Ke).call(this,e,t)).reduce((e,n)=>(e[n]=t[n],e),{}),a=(0,A.setDiff)(n,s),i=(0,A.setDiff)(s,n);return{newConnections:a,unusedConnections:i,approvedConnections:(0,A.setDiff)(s,i)}}function Xe(e,t){if(r(D,this).useCaip25Permission&&Object.keys(t).includes(p.SnapEndowments.EthereumProvider)){const n=this.messagingSystem.call("SelectedNetworkController:getNetworkClientIdForDomain",e),{configuration:s}=this.messagingSystem.call("NetworkController:getNetworkClientById",n),a=(0,f.hexToNumber)(s.chainId);return{...t,"endowment:caip25":{caveats:[{type:"authorizedScopes",value:{requiredScopes:{},optionalScopes:{[`eip155:${a}`]:{accounts:[]}},sessionProperties:{},isMultichainOrigin:!1}}]}}}return t}function Ze({snapId:e,unusedPermissions:t={},newPermissions:n={},requestData:s}){const a=Object.keys(t);if((0,f.isNonEmptyArray)(a)&&this.messagingSystem.call("PermissionController:revokePermissions",{[e]:a}),(0,f.isNonEmptyArray)(Object.keys(n))){const t=c(X,this,Xe).call(this,e,n);this.messagingSystem.call("PermissionController:grantPermissions",{approvedPermissions:t,subject:{origin:e},requestData:s})}}function Qe(e,t){const n=this.getExpect(e);return!(0,f.satisfiesVersionRange)(n.version,t)&&!(0,f.gtRange)(n.version,t)}function et(e,t){const n=this.getRunnableSnaps();for(const{id:s}of n){this.messagingSystem.call("PermissionController:hasPermission",s,p.SnapEndowments.LifecycleHooks)&&c(X,this,tt).call(this,e,s,t).catch(e=>{(0,m.logError)(`Error calling lifecycle hook "${t}" for Snap "${s}": ${(0,h.getErrorMessage)(e)}`)})}}async function tt(e,t,n){const s=p.handlerEndowments[n];(0,f.assert)(s,"Lifecycle hook must have an endowment.");this.messagingSystem.call("PermissionController:hasPermission",t,s)&&await this.handleRequest({snapId:t,handler:n,origin:e,request:{jsonrpc:"2.0",method:n}})}function nt(){for(const e of r(q,this).values())e.encryptionKey=null,e.encryptionSalt=null,e.state=undefined}n.SnapController=Q}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/SnapController.cjs"}],[2497,{"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){function s(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var s=n.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(n,"__esModule",{value:!0}),n.Timer=void 0;const a=e("@metamask/utils");n.Timer=class{constructor(e){s(this,"state",void 0),(0,a.assert)(!Number.isNaN(e),new TypeError("Can't start a timer with NaN time")),(0,a.assert)(e>=0,new TypeError("Can't start a timer with negative time")),this.state={value:"stopped",remaining:e}}get status(){return this.state.value}get remaining(){return this.state.remaining}cancel(){(0,a.assert)("paused"===this.status||"running"===this.status,new Error("Tried to cancel a not running Timer")),this.onFinish(!1)}finish(){(0,a.assert)("finished"!==this.status,new Error("Tried to finish a finished Timer.")),this.onFinish(!0)}pause(){(0,a.assert)("running"===this.state.value,new Error("Tried to pause a not running Timer"));const{callback:e,start:t,timeout:n,remaining:s}=this.state;n!==undefined&&clearTimeout(n),this.state={value:"paused",callback:e,remaining:s-(Date.now()-t)}}start(e){(0,a.assert)("stopped"===this.state.value,new Error("Tried to start an already running Timer"));const{remaining:t}=this.state;this.state={value:"paused",remaining:t,callback:e},this.resume()}resume(){(0,a.assert)("paused"===this.state.value,new Error("Tried to resume not paused Timer"));const{remaining:e,callback:t}=this.state,n=Date.now();let s;e!==Number.POSITIVE_INFINITY&&(s=setTimeout(()=>this.onFinish(!0),e)),this.state={value:"running",callback:t,remaining:e,start:n,timeout:s}}onFinish(e){(0,a.assert)("running"===this.state.value||"paused"===this.state.value),"running"===this.state.value&&this.state.timeout!==undefined&&clearTimeout(this.state.timeout);const{callback:t,remaining:n}=this.state;this.state={value:"finished",remaining:"running"===this.state.value?n-(Date.now()-this.state.start):n},e&&t()}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/Timer.cjs"}],[2498,{"@metamask/snaps-rpc-methods":2543,"@metamask/snaps-utils":2713},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.CLIENT_ONLY_HANDLERS=n.METAMASK_ORIGIN=n.STATE_DEBOUNCE_TIMEOUT=n.LEGACY_ENCRYPTION_KEY_DERIVATION_OPTIONS=n.ALLOWED_PERMISSIONS=void 0;const s=e("@metamask/snaps-rpc-methods"),a=e("@metamask/snaps-utils");n.ALLOWED_PERMISSIONS=Object.freeze(["snap_dialog","snap_manageState","snap_notify","snap_getLocale",s.SnapEndowments.Cronjob,s.SnapEndowments.HomePage,s.SnapEndowments.LifecycleHooks,s.SnapEndowments.EthereumProvider,s.SnapEndowments.TransactionInsight,s.SnapEndowments.SignatureInsight]),n.LEGACY_ENCRYPTION_KEY_DERIVATION_OPTIONS={algorithm:"PBKDF2",params:{iterations:1e4}},n.STATE_DEBOUNCE_TIMEOUT=500,n.METAMASK_ORIGIN="metamask",n.CLIENT_ONLY_HANDLERS=Object.freeze([a.HandlerType.OnClientRequest,a.HandlerType.OnSignature,a.HandlerType.OnTransaction,a.HandlerType.OnCronjob,a.HandlerType.OnNameLookup,a.HandlerType.OnHomePage,a.HandlerType.OnSettingsPage,a.HandlerType.OnUserInput,a.HandlerType.OnAssetsLookup,a.HandlerType.OnAssetsConversion,a.HandlerType.OnAssetHistoricalPrice,a.HandlerType.OnAssetsMarketData,a.HandlerType.OnWebSocketEvent])}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/constants.cjs"}],[2499,{"./SnapController.cjs":2496,"./constants.cjs":2498,"./location/index.cjs":2501,"./registry/index.cjs":2505,"./selectors.cjs":2508},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){var s=Object.create?function(e,t,n,s){s===undefined&&(s=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,a)}:function(e,t,n,s){s===undefined&&(s=n),e[s]=t[n]},a=function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(n,"__esModule",{value:!0}),a(e("./constants.cjs"),n),a(e("./location/index.cjs"),n),a(e("./SnapController.cjs"),n),a(e("./selectors.cjs"),n),a(e("./registry/index.cjs"),n)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/index.cjs"}],[25,{"../../../../shared/lib/trace":5546,"../../../../shared/modules/selectors":5574,"../../../../shared/modules/shield":5578,"../../lib/smart-transaction/smart-transactions":241,"../../lib/transaction/hooks/enforce-simulation-hook":267,"../../lib/transaction/metrics":268,"@metamask/smart-transactions-controller/dist/types":2463,"@metamask/transaction-controller":2790,_process:4803},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){(function(t){(function(){Object.defineProperty(n,"__esModule",{value:!0}),n.TransactionControllerInit=void 0;var s=e("@metamask/transaction-controller"),a=e("@metamask/smart-transactions-controller/dist/types"),i=e("../../../../shared/modules/selectors"),r=e("../../lib/smart-transaction/smart-transactions"),o=e("../../../../shared/lib/trace"),c=e("../../lib/transaction/metrics"),l=e("../../lib/transaction/hooks/enforce-simulation-hook"),u=e("../../../../shared/modules/shield");n.TransactionControllerInit=e=>{var n;const{controllerMessenger:d,initMessenger:p,getFlatState:h,getPermittedAccounts:m,getTransactionMetricsRequest:f,updateAccountBalanceForTransactionNetwork:g,persistedState:y}=e,{gasFeeController:S,keyringController:v,networkController:b,onboardingController:T,preferencesController:w,smartTransactionsController:_}=function(e){return{gasFeeController:()=>e.getController("GasFeeController"),keyringController:()=>e.getController("KeyringController"),networkController:()=>e.getController("NetworkController"),onboardingController:()=>e.getController("OnboardingController"),preferencesController:()=>e.getController("PreferencesController"),smartTransactionsController:()=>e.getController("SmartTransactionsController"),institutionalSnapController:()=>e.getController("InstitutionalSnapController")}}(e),E=new s.TransactionController({getCurrentNetworkEIP1559Compatibility:()=>p.call("NetworkController:getEIP1559Compatibility"),getCurrentAccountEIP1559Compatibility:async()=>!0,getExternalPendingTransactions:e=>function(e,t){return e.getTransactions({addressFrom:t,status:a.SmartTransactionStatuses.PENDING})}(_(),e),getGasFeeEstimates:(...e)=>S().fetchGasFeeEstimates(...e),getNetworkClientRegistry:(...e)=>b().getNetworkClientRegistry(...e),getNetworkState:()=>b().state,getPermittedAccounts:m,getSavedGasFees:e=>w().state.advancedGasFee[e],getSimulationConfig:async e=>(0,u.getShieldGatewayConfig)(()=>p.call("AuthenticationController:getBearerToken"),e),incomingTransactions:{client:`extension-${null===(n=t.env.METAMASK_VERSION)||void 0===n?void 0:n.replace(/\./gu,"-")}`,includeTokenTransfers:!1,isEnabled:()=>w().state.useExternalServices&&T().state.completedOnboarding,updateTransactions:!0},isAutomaticGasFeeUpdateEnabled:({type:e})=>{const t=[s.TransactionType.swap,s.TransactionType.swapApproval,s.TransactionType.bridge,s.TransactionType.bridgeApproval];return!e||!t.includes(e)},isEIP7702GasFeeTokensEnabled:async e=>{const{chainId:t}=e,n={metamask:h()};return!(0,i.getIsSmartTransaction)(n,t)},isFirstTimeInteractionEnabled:()=>w().state.securityAlertsEnabled,isSimulationEnabled:()=>w().state.useTransactionSimulations,messenger:d,pendingTransactions:{isResubmitEnabled:()=>!1},publicKeyEIP7702:"0x3c7a1cCCe462e96D186B8ca9a1BCB2010C3dABa3",testGasFeeFlows:Boolean(!1),trace:o.trace,hooks:{afterSimulate:new l.EnforceSimulationHook({messenger:p}).getAfterSimulateHook(),beforePublish:e=>p.call("InstitutionalSnapController:publishHook",e),beforeSign:new l.EnforceSimulationHook({messenger:p}).getBeforeSignHook(),beforeCheckPendingTransactions:e=>p.call("InstitutionalSnapController:beforeCheckPendingTransactionHook",e),publish:(e,t)=>(0,r.publishSmartTransactionHook)({flatState:h(),initMessenger:p,signedTx:t,smartTransactionsController:_(),transactionController:E,transactionMeta:e}),publishBatch:async e=>await(0,r.publishBatchSmartTransactionHook)({transactionController:E,smartTransactionsController:_(),hookControllerMessenger:p,flatState:h(),transactions:e.transactions})},sign:(...e)=>v().signTransaction(...e),state:y.TransactionController});!function(e,t,n){const s=t();e.subscribe("TransactionController:unapprovedTransactionAdded",n),e.subscribe("TransactionController:transactionConfirmed",n),e.subscribe("TransactionController:postTransactionBalanceUpdated",c.handlePostTransactionBalanceUpdate.bind(null,s)),e.subscribe("TransactionController:unapprovedTransactionAdded",e=>(0,c.handleTransactionAdded)(s,{transactionMeta:e})),e.subscribe("TransactionController:transactionApproved",c.handleTransactionApproved.bind(null,s)),e.subscribe("TransactionController:transactionDropped",c.handleTransactionDropped.bind(null,s)),e.subscribe("TransactionController:transactionConfirmed",c.handleTransactionConfirmed.bind(null,s)),e.subscribe("TransactionController:transactionFailed",c.handleTransactionFailed.bind(null,s)),e.subscribe("TransactionController:transactionNewSwap",({transactionMeta:t})=>e.call("SwapsController:setTradeTxId",t.id)),e.subscribe("TransactionController:transactionNewSwapApproval",({transactionMeta:t})=>e.call("SwapsController:setApproveTxId",t.id)),e.subscribe("TransactionController:transactionRejected",c.handleTransactionRejected.bind(null,s)),e.subscribe("TransactionController:transactionSubmitted",c.handleTransactionSubmitted.bind(null,s))}(p,f,g);const k=function(e){return{abortTransactionSigning:e.abortTransactionSigning.bind(e),getLayer1GasFee:e.getLayer1GasFee.bind(e),getTransactions:e.getTransactions.bind(e),isAtomicBatchSupported:e.isAtomicBatchSupported.bind(e),startIncomingTransactionPolling:e.startIncomingTransactionPolling.bind(e),stopIncomingTransactionPolling:e.stopIncomingTransactionPolling.bind(e),updateAtomicBatchData:e.updateAtomicBatchData.bind(e),updateBatchTransactions:e.updateBatchTransactions.bind(e),updateEditableParams:e.updateEditableParams.bind(e),updatePreviousGasParams:e.updatePreviousGasParams.bind(e),updateSelectedGasFeeToken:e.updateSelectedGasFeeToken.bind(e),updateTransactionGasFees:e.updateTransactionGasFees.bind(e),updateTransactionSendFlowHistory:e.updateTransactionSendFlowHistory.bind(e)}}(E);return{controller:E,api:k,memStateKey:"TxController"}}}).call(this)}).call(this,e("_process"))}}},{package:"$root$",file:"app/scripts/controller-init/confirmations/transaction-controller-init.ts"}],[250,{"../../../../shared/constants/start-up-errors":5476,"../../../../shared/constants/state-corruption":5477,"../start-up-errors/start-up-errors":249,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.CorruptionHandler=void 0,n.hasVault=c;var s=e("@metamask/utils"),a=e("../../../../shared/constants/state-corruption"),i=e("../start-up-errors/start-up-errors"),r=e("../../../../shared/constants/start-up-errors");function o(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var s=n.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){if((0,s.isObject)(e)&&(0,s.hasProperty)(e,"KeyringController")){const t=e.KeyringController;if((0,s.isObject)(t)&&(0,s.hasProperty)(t,"vault"))return Boolean(t.vault)}return!1}n.CorruptionHandler=class{constructor(){o(this,"connectedPorts",new Set)}async handleStateCorruptionError({port:e,error:t,database:n,repairCallback:o}){const{connectedPorts:l}=this,u=await async function(e,t){let n=(0,s.isObject)(e)&&(0,s.hasProperty)(e,"backup")&&null!==e.backup?e.backup:null;if(!n)try{n=await t.getBackup()??null}catch{n=null}return n}(t,n),d=function(e){if((0,s.isObject)(e)&&(0,s.hasProperty)(e,"PreferencesController")){const t=e.PreferencesController;if((0,s.isObject)(t)&&(0,s.hasProperty)(t,"currentLocale")&&"string"==typeof t.currentLocale)return t.currentLocale}return null}(u),p=Boolean(c(u));return(0,i.tryPostMessage)(e,a.METHOD_DISPLAY_STATE_CORRUPTION_ERROR,{error:{message:t.message,name:t.name,stack:t.stack},currentLocale:d,hasBackup:p})?new Promise((t,n)=>{l.add(e),e.onDisconnect.addListener(function(){l.delete(e),t()}),e.onMessage.addListener(async function e(s){var c;if((null==s||null===(c=s.data)||void 0===c?void 0:c.method)===a.METHOD_REPAIR_DATABASE){l.forEach(t=>t.onMessage.removeListener(e));try{await async function(e){return await navigator.locks.request("repairDatabase",{ifAvailable:!0},async function(t){return null!==t&&(await e(),!0)})}(async function(){try{await o(u)}finally{l.forEach(e=>{(0,i.tryPostMessage)(e,r.RELOAD_WINDOW)})}}),t()}catch(e){n(e)}}})}):Promise.resolve()}}}}},{package:"$root$",file:"app/scripts/lib/state-corruption/state-corruption-recovery.ts"}],[2500,{"@metamask/snaps-utils":2713,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){function s(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var s=n.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(n,"__esModule",{value:!0}),n.HttpLocation=void 0;const a=e("@metamask/snaps-utils"),i=e("@metamask/utils");n.HttpLocation=class{constructor(e,t={}){s(this,"cache",new Map),s(this,"validatedManifest",void 0),s(this,"url",void 0),s(this,"fetchFn",void 0),s(this,"fetchOptions",void 0),(0,i.assertStruct)(e.toString(),a.HttpSnapIdStruct,"Invalid Snap Id: "),this.fetchFn=t.fetch??globalThis.fetch.bind(undefined),this.fetchOptions=t.fetchOptions,this.url=e}async manifest(){if(this.validatedManifest)return this.validatedManifest.clone();const e=new URL(a.NpmSnapFileNames.Manifest,this.url).toString(),t=await this.fetchFn(e,this.fetchOptions);if(!t.ok)throw new Error(`Failed to fetch "${e}". Status code: ${t.status}.`);const n=await t.text(),s=(0,a.parseJson)(n),i=new a.VirtualFile({value:n,result:(0,a.createSnapManifest)(s),path:a.NpmSnapFileNames.Manifest,data:{canonicalPath:e}});return this.validatedManifest=i,this.manifest()}async fetch(e){const t=(0,a.normalizeRelative)(e),n=this.cache.get(t);if(n!==undefined)return n.clone();const s=this.toCanonical(t).toString(),r=await this.fetchFn(s,this.fetchOptions);if(!r.ok)throw new Error(`Failed to fetch "${s}". Status code: ${r.status}.`);const o=await r.arrayBuffer(),c=new a.VirtualFile({value:new Uint8Array(o),path:t,data:{canonicalPath:s}});return(0,i.assert)(!this.cache.has(t),"Corrupted cache, multiple files with same path."),this.cache.set(t,c),this.fetch(t)}get root(){return new URL(this.url)}toCanonical(e){return(0,i.assert)(!e.startsWith("/"),"Tried to parse absolute path."),new URL(e,this.url)}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/http.cjs"}],[2501,{"./http.cjs":2500,"./local.cjs":2502,"./location.cjs":2503,"./npm.cjs":2504},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){var s=Object.create?function(e,t,n,s){s===undefined&&(s=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,a)}:function(e,t,n,s){s===undefined&&(s=n),e[s]=t[n]},a=function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(n,"__esModule",{value:!0}),a(e("./location.cjs"),n),a(e("./npm.cjs"),n),a(e("./local.cjs"),n),a(e("./http.cjs"),n)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/index.cjs"}],[2502,{"./http.cjs":2500,"@metamask/snaps-utils":2713,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){function s(e,t,n){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,n)}function a(e,t){return e.get(i(e,t))}function i(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}Object.defineProperty(n,"__esModule",{value:!0}),n.LocalLocation=void 0;const r=e("@metamask/snaps-utils"),o=e("@metamask/utils"),c=e("./http.cjs");var l=new WeakMap;function u(e){return(0,o.assert)(e.data.canonicalPath!==undefined),e.data.canonicalPath=`local:${e.data.canonicalPath}`,e}n.LocalLocation=class{constructor(e,t={}){var n,a,u;s(this,l,void 0),(0,o.assertStruct)(e.toString(),r.LocalSnapIdStruct,"Invalid Snap Id"),(0,o.assert)(t.fetchOptions===undefined,"Currently adding fetch options to local: is unsupported."),n=l,a=this,u=new c.HttpLocation(new URL(e.toString().slice(r.SnapIdPrefixes.local.length)),{...t,fetchOptions:{cache:"no-cache"}}),n.set(i(n,a),u)}async manifest(){return u(await a(l,this).manifest())}async fetch(e){return u(await a(l,this).fetch(e))}get shouldAlwaysReload(){return!0}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/local.cjs"}],[2503,{"./http.cjs":2500,"./local.cjs":2502,"./npm.cjs":2504,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.detectSnapLocation=void 0;const s=e("@metamask/utils"),a=e("./http.cjs"),i=e("./local.cjs"),r=e("./npm.cjs");n.detectSnapLocation=function(e,t){const n=(null==t?void 0:t.allowHttp)??!1,o=(null==t?void 0:t.allowLocal)??!1,c=new URL(e);switch(c.protocol){case"npm:":return new r.NpmLocation(c,t);case"local:":return(0,s.assert)(o,new TypeError("Fetching local snaps is disabled.")),new i.LocalLocation(c,t);case"http:":case"https:":return(0,s.assert)(n,new TypeError("Fetching snaps through http/https is disabled.")),new a.HttpLocation(c,t);default:throw new TypeError(`Unrecognized "${c.protocol}" snap location protocol.`)}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/location.cjs"}],[2504,{"@metamask/snaps-utils":2713,"@metamask/utils":2835,"concat-stream":2512,"get-npm-tarball-url":4187,"readable-stream":5008,"readable-web-to-node-stream":5009,"tar-stream":2516},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){function s(e,t,n){a(e,t),t.set(e,n)}function a(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var s=n.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t,n){return e.set(c(e,t),n),n}function o(e,t){return e.get(c(e,t))}function c(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}var l=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.getNpmCanonicalBasePath=n.fetchNpmMetadata=n.NpmLocation=n.TARBALL_SIZE_SAFETY_LIMIT=n.BaseNpmLocation=n.DEFAULT_NPM_REGISTRY=void 0;const u=e("@metamask/snaps-utils"),d=e("@metamask/utils"),p=l(e("concat-stream")),h=l(e("get-npm-tarball-url")),m=e("readable-stream"),f=e("readable-web-to-node-stream"),g=e("tar-stream");n.DEFAULT_NPM_REGISTRY=new URL("https://registry.npmjs.org");var y=new WeakMap,S=new WeakMap,v=new WeakSet;class b{constructor(e,t={}){var r,o;a(r=this,o=v),o.add(r),i(this,"meta",void 0),s(this,y,void 0),s(this,S,void 0);const c=t.allowCustomRegistries??!1,l=t.fetch??globalThis.fetch.bind(undefined),p=t.versionRange??u.DEFAULT_REQUESTED_SNAP_VERSION,h=t.resolveVersion??(async e=>e);let m;(0,d.assertStruct)(e.toString(),u.NpmSnapIdStruct,"Invalid Snap Id: "),""===e.host&&""===e.port&&""===e.username&&""===e.password?m=n.DEFAULT_NPM_REGISTRY:(m="https://",e.username&&(m+=e.username,e.password&&(m+=`:${e.password}`),m+="@"),m+=e.host,m=new URL(m),(0,d.assert)(c,new TypeError(`Custom NPM registries are disabled, tried to use "${m.toString()}".`))),(0,d.assert)("/"===m.pathname&&""===m.search&&""===m.hash),(0,d.assert)(""!==e.pathname&&"/"!==e.pathname,new TypeError("The package name in NPM location is empty."));let f=e.pathname;f.startsWith("/")&&(f=f.slice(1)),this.meta={requestedRange:p,registry:m,packageName:f,fetch:l,resolveVersion:h}}async manifest(){if(o(y,this))return o(y,this).clone();const e=await this.fetch("snap.manifest.json"),t=(0,u.parseJson)(e.toString());return e.result=(0,u.createSnapManifest)(t),r(y,this,e),this.manifest()}async fetch(e){const t=(0,u.normalizeRelative)(e);o(S,this)||(await c(v,this,T).call(this),(0,d.assert)(o(S,this)!==undefined));const n=o(S,this).get(t);return(0,d.assert)(n!==undefined,new TypeError(`File "${e}" not found in package.`)),n.clone()}get packageName(){return this.meta.packageName}get version(){return(0,d.assert)(this.meta.version!==undefined,"Tried to access version without first fetching NPM package."),this.meta.version}get registry(){return this.meta.registry}get versionRange(){return this.meta.requestedRange}}async function T(){(0,d.assert)(o(S,this)===undefined);const e=await this.meta.resolveVersion(this.meta.requestedRange),{tarballURL:t,targetVersion:n}=await async function(e,t,n,s){var a;if(E(n)&&(0,d.isValidSemVerVersion)(t))return{tarballURL:(0,h.default)(e,t),targetVersion:t};const i=await w(e,n,s),r=Object.keys((null==i?void 0:i.versions)??{}).map(e=>((0,d.assertIsSemVerVersion)(e),e)),o=(0,u.getTargetVersion)(r,t);if(null===o)throw new Error(`Failed to find a matching version in npm metadata for package "${e}" and requested semver range "${t}".`);const c=null==i||null===(a=i.versions)||void 0===a||null===(a=a[o])||void 0===a||null===(a=a.dist)||void 0===a?void 0:a.tarball;return{tarballURL:c,targetVersion:o}}(this.meta.packageName,e,this.meta.registry,this.meta.fetch);if(!(0,u.isValidUrl)(t)||!t.toString().endsWith(".tgz"))throw new Error(`Failed to find valid tarball URL in NPM metadata for package "${this.meta.packageName}".`);const s=new URL(t);s.hostname=this.meta.registry.hostname,s.protocol=this.meta.registry.protocol;const a=await this.fetchNpmTarball(s);r(S,this,a),this.meta.version=n}n.BaseNpmLocation=b,n.TARBALL_SIZE_SAFETY_LIMIT=262144e3;async function w(e,t,n){const s=await n(new URL(e,t).toString(),{headers:{accept:E(t)?"application/vnd.npm.install-v1+json; q=1.0, application/json; q=0.8, */*":"application/json"}});if(!s.ok)throw new Error(`Failed to fetch NPM registry entry. Status code: ${s.status}.`);const a=await s.json();if(!(0,d.isObject)(a))throw new Error(`Failed to fetch package "${e}" metadata from npm.`);return a}function _(e,t){let n="npm://";return""!==e.username&&(n+=e.username,""!==e.password&&(n+=`:${e.password}`),n+="@"),`${n}${e.host}/${t}/`}function E(e){return e.toString()===n.DEFAULT_NPM_REGISTRY.toString()}n.NpmLocation=class extends b{async fetchNpmTarball(e){const t=await this.meta.fetch(e.toString());(0,d.assert)(404!==t.status,`"${this.meta.packageName}" was not found in the NPM registry`),(0,d.assert)(t.ok&&t.body,`Failed to fetch tarball for package "${this.meta.packageName}"`);const s=t.headers.get("content-length");(0,d.assert)(s,"Snap tarball has invalid content-length");const a=parseInt(s,10);return(0,d.assert)(a<=n.TARBALL_SIZE_SAFETY_LIMIT,"Snap tarball exceeds size limit"),new Promise((e,s)=>{const a=new Map,i=function(e,t){(0,d.assert)(e.endsWith("/"),"Base needs to end with '/' for relative paths to be added as children instead of siblings."),(0,d.assert)(e.startsWith("npm:"),'Protocol mismatch, expected "npm:".');const s=(0,g.extract)();let a=0;return s.on("entry",(i,r,o)=>{const{name:c,type:l}=i;if("file"===l){const i=c.replace(k,"");return r.pipe((0,p.default)({encoding:"uint8array"},r=>{try{a+=r.byteLength,(0,d.assert)(a<n.TARBALL_SIZE_SAFETY_LIMIT,`Snap tarball exceeds limit of ${n.TARBALL_SIZE_SAFETY_LIMIT} bytes.`);const s=new u.VirtualFile({value:r,path:i,data:{canonicalPath:new URL(i,e).toString()}});return(0,d.assert)(!t.has(i),"Malformed tarball, multiple files with the same path."),t.set(i,s),o()}catch(e){return s.destroy(e)}}))}return r.on("end",()=>o()),r.resume()}),s}(_(this.meta.registry,this.meta.packageName),a),r=t.body,o=new DecompressionStream("gzip"),c=r.pipeThrough(o);(0,m.pipeline)(function(e){if("function"!=typeof e.getReader)return e;return new f.ReadableWebToNodeStream(e)}(c),i,t=>{t?s(t):e(a)})})}},n.fetchNpmMetadata=w,n.getNpmCanonicalBasePath=_;const k=/^package\//u}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/npm.cjs"}],[2505,{"./json.cjs":2506,"./registry.cjs":2507},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){var s=Object.create?function(e,t,n,s){s===undefined&&(s=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,a)}:function(e,t,n,s){s===undefined&&(s=n),e[s]=t[n]},a=function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(n,"__esModule",{value:!0}),a(e("./registry.cjs"),n),a(e("./json.cjs"),n)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/registry/index.cjs"}],[2506,{"./registry.cjs":2507,"@metamask/base-controller":1203,"@metamask/snaps-registry":2522,"@metamask/snaps-utils":2713,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){function s(e,t,n){a(e,t),t.set(e,n)}function a(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(e,t){return e.get(o(e,t))}function r(e,t,n){return e.set(o(e,t),n),n}function o(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}Object.defineProperty(n,"__esModule",{value:!0}),n.JsonSnapsRegistry=void 0;const c=e("@metamask/base-controller"),l=e("@metamask/snaps-registry"),u=e("@metamask/snaps-utils"),d=e("@metamask/utils"),p=e("./registry.cjs"),h={database:null,lastUpdated:null,databaseUnavailable:!1};var m=new WeakMap,f=new WeakMap,g=new WeakMap,y=new WeakMap,S=new WeakMap,v=new WeakMap,b=new WeakSet;class T extends c.BaseController{constructor({messenger:e,state:t,url:n={registry:"https://acl.execution.metamask.io/latest/registry.json",signature:"https://acl.execution.metamask.io/latest/signature.json"},publicKey:i="0x025b65308f0f0fb8bc7f7ff87bfc296e0330eee5d3c1d1ee4a048b2fd6a86fa0a6",fetchFunction:c=globalThis.fetch.bind(undefined),recentFetchThreshold:l=(0,d.inMilliseconds)(5,d.Duration.Minute),refetchOnAllowlistMiss:u=!0}){var p,T;super({messenger:e,metadata:{database:{persist:!0,anonymous:!1},lastUpdated:{persist:!0,anonymous:!1},databaseUnavailable:{persist:!0,anonymous:!1}},name:"SnapsRegistry",state:{...h,...t}}),a(p=this,T=b),T.add(p),s(this,m,void 0),s(this,f,void 0),s(this,g,void 0),s(this,y,void 0),s(this,S,void 0),s(this,v,void 0),r(m,this,n),r(f,this,i),r(g,this,c),r(y,this,l),r(S,this,u),r(v,this,null),this.messagingSystem.registerActionHandler("SnapsRegistry:get",async(...e)=>o(b,this,A).call(this,...e)),this.messagingSystem.registerActionHandler("SnapsRegistry:getMetadata",(...e)=>o(b,this,I).call(this,...e)),this.messagingSystem.registerActionHandler("SnapsRegistry:resolveVersion",async(...e)=>o(b,this,C).call(this,...e)),this.messagingSystem.registerActionHandler("SnapsRegistry:update",async()=>o(b,this,_).call(this))}}function w(){return this.state.lastUpdated&&Date.now()-this.state.lastUpdated<i(y,this)}async function _(){i(v,this)?await i(v,this):(null===i(v,this)&&r(v,this,o(b,this,E).call(this)),await i(v,this),r(v,this,null))}async function E(){if(!o(b,this,w).call(this))try{const[e,t]=await Promise.all([o(b,this,R).call(this,i(m,this).registry),o(b,this,R).call(this,i(m,this).signature)]);o(b,this,M).call(this,e,t),this.update(t=>{t.database=JSON.parse(e),t.lastUpdated=Date.now(),t.databaseUnavailable=!1})}catch{this.update(e=>{e.databaseUnavailable=!0})}}async function k(){return null===this.state.database&&await o(b,this,_).call(this),this.state.database}async function P(e,t,n=!1){var s;const a=await o(b,this,k).call(this),r=null==a?void 0:a.blockedSnaps.find(n=>"id"in n?n.id===e&&(0,d.satisfiesVersionRange)(t.version,n.versionRange):n.checksum===t.checksum);if(r)return{status:p.SnapsRegistryStatus.Blocked,reason:r.reason};const c=null==a?void 0:a.verifiedSnaps[e],l=null==c||null===(s=c.versions)||void 0===s?void 0:s[t.version];return l&&l.checksum===t.checksum?{status:p.SnapsRegistryStatus.Verified}:i(S,this)&&!n?(await o(b,this,_).call(this),o(b,this,P).call(this,e,t,!0)):{status:this.state.databaseUnavailable?p.SnapsRegistryStatus.Unavailable:p.SnapsRegistryStatus.Unverified}}async function A(e){return Object.entries(e).reduce(async(e,[t,n])=>{const s=await o(b,this,P).call(this,t,n),a=await e;return a[t]=s,a},Promise.resolve({}))}async function C(e,t,n=!1){var s;const a=await o(b,this,k).call(this),r=(null==a||null===(s=a.verifiedSnaps[e])||void 0===s?void 0:s.versions)??null;if(!r&&i(S,this)&&!n)return await o(b,this,_).call(this),o(b,this,C).call(this,e,t,!0);if(!r)return t;const c=(0,u.getTargetVersion)(Object.keys(r),t);return c||!i(S,this)||n?c?((0,d.assertIsSemVerRange)(c),c):t:(await o(b,this,_).call(this),o(b,this,C).call(this,e,t,!0))}function I(e){var t;return(null===(t=this.state)||void 0===t||null===(t=t.database)||void 0===t||null===(t=t.verifiedSnaps[e])||void 0===t?void 0:t.metadata)??null}function M(e,t){(0,d.assert)(i(f,this),"No public key provided.");const n=(0,l.verify)({registry:e,signature:JSON.parse(t),publicKey:i(f,this)});(0,d.assert)(n,"Invalid registry signature.")}async function R(e){const t=await i(g,this).call(this,e);if(!t.ok)throw new Error(`Failed to fetch ${e}.`);return await t.text()}n.JsonSnapsRegistry=T}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/registry/json.cjs"}],[2507,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){var s;Object.defineProperty(n,"__esModule",{value:!0}),n.SnapsRegistryStatus=void 0,function(e){e[e.Unverified=0]="Unverified",e[e.Blocked=1]="Blocked",e[e.Verified=2]="Verified",e[e.Unavailable=3]="Unavailable"}(s||(n.SnapsRegistryStatus=s={}))}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/registry/registry.cjs"}],[2508,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.getRunnableSnaps=void 0;n.getRunnableSnaps=e=>e.filter(e=>e.enabled&&!e.blocked)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/selectors.cjs"}],[2509,{"./snaps/Timer.cjs":2497,"@metamask/snaps-sdk":2599,"@metamask/snaps-utils":2713,"fast-deep-equal":4134},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){var s=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.isLocalSnapId=n.isTrackableHandler=n.throttleTracking=n.TRACKABLE_HANDLERS=n.debouncePersistState=n.fetchSnap=n.getSnapFiles=n.withTimeout=n.hasTimedOut=n.delayWithTimer=n.delay=n.permissionsDiff=n.setDiff=void 0;const a=e("@metamask/snaps-sdk"),i=e("@metamask/snaps-utils"),r=s(e("fast-deep-equal")),o=e("./snaps/Timer.cjs");function c(e,t){let n;const s=new Promise((s,a)=>{e.start(()=>{t===undefined?s():s(t)}),n=a});return s.cancel=()=>{"finished"!==e.status&&(e.cancel(),n(new Error("The delay has been canceled.")))},s}async function l(e,t){return t&&0!==t.length?await Promise.all(t.map(async t=>e.fetch(t))):[]}n.setDiff=function(e,t){return Object.entries(e).reduce((e,[n,s])=>(n in t||(e[n]=s),e),{})},n.permissionsDiff=function(e,t){return Object.entries(e).reduce((e,[n,s])=>{const a=n in t;return(!a||a&&!(0,r.default)(s.caveats??[],t[n].caveats??[]))&&(e[n]=s),e},{})},n.delay=function(e,t){return c(new o.Timer(e),t)},n.delayWithTimer=c,n.hasTimedOut=Symbol("Used to check if the requested promise has timeout (see withTimeout)"),n.withTimeout=async function(e,t){const s=c("number"==typeof t?new o.Timer(t):t,n.hasTimedOut);try{return await Promise.race([e,s])}finally{s.cancel()}},n.getSnapFiles=l,n.fetchSnap=async function(e,t){try{const e=await t.manifest(),n=await t.fetch(e.result.source.location.npm.filePath);(0,a.assert)(n.size<i.MAX_FILE_SIZE,"Snap source code must be smaller than 64 MB.");const{iconPath:s}=e.result.source.location.npm,r=s?await t.fetch(s):undefined,o=await l(t,e.result.source.files);(0,i.validateAuxiliaryFiles)(o),await Promise.all(o.map(async e=>{e.data.base64=await(0,i.encodeBase64)(e)}));const c=await l(t,e.result.source.locales),u={manifest:e,sourceCode:n,svgIcon:r,auxiliaryFiles:o,localizationFiles:(0,i.getValidatedLocalizationFiles)(c)};return await(0,i.validateFetchedSnap)(u),u}catch(t){throw new Error(`Failed to fetch snap "${e}": ${(0,a.getErrorMessage)(t)}.`)}},n.debouncePersistState=function(e,t=1e3){const n=new Map;return(s,a,i)=>{const r=`${s}-${i}`;n.has(r)&&clearTimeout(n.get(r)),n.set(r,setTimeout(()=>{e(s,a,i),n.delete(r)},t))}},n.TRACKABLE_HANDLERS=Object.freeze([i.HandlerType.OnHomePage,i.HandlerType.OnInstall,i.HandlerType.OnNameLookup,i.HandlerType.OnRpcRequest,i.HandlerType.OnSignature,i.HandlerType.OnTransaction,i.HandlerType.OnUpdate]),n.throttleTracking=function(e,t=6e4){const n=new Map,s=new Map;return(a,i,r,o)=>{const c=`${a}${i}${r}${o}`,l=Date.now(),u=n.get(c)??0,d=[a,i,r,o];if(l-u>=t)return n.set(c,l),void e(...d);const p=s.get(c);null!=p&&p.timer&&clearTimeout(p.timer),n.set(c,l),s.set(c,{args:d,timer:setTimeout(()=>{e(...d),s.delete(c)},t)})}},n.isTrackableHandler=function(e){return n.TRACKABLE_HANDLERS.includes(e)},n.isLocalSnapId=function(e){return e.startsWith("local:")}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/utils.cjs"}],[251,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.sanitizeUIState=function(e){const t={...e};for(const e of s)delete t[e];return function(e){const t=e.snaps;if(!t)return;e.snaps=Object.values(t).reduce((e,t)=>(e[t.id]=function(e){const t={...e};return delete t.sourceCode,delete t.auxiliaryFiles,t}(t),e),{})}(t),function(e){const t=e.srpSessionData;if(!t)return;e.srpSessionData=Object.entries(t).reduce((e,[t,n])=>{const s={...n.token};return delete s.accessToken,e[t]={...n,token:s},e},{})}(t),function(e){const t=["vault","vaultEncryptionKey","vaultEncryptionSalt","encryptedSeedlessEncryptionKey","encryptedKeyringEncryptionKey","accessToken","metadataAccessToken","refreshToken","revokeToken"];for(const n of t)delete e[n];const n=e.nodeAuthTokens;n&&(e.nodeAuthTokens=n.map(e=>{const t={...e};return delete t.authToken,t}));const s=e.socialBackupsMetadata;s&&(e.socialBackupsMetadata=s.map(e=>{const t={...e};return delete t.hash,t}))}(t),t};const s=["snapStates","unencryptedSnapStates","phishingLists","whitelist","hotlistLastFetched","stalelistLastFetched","c2DomainBlocklistLastFetched","vault","encryptionKey","encryptionSalt"]}}},{package:"$root$",file:"app/scripts/lib/state-utils.ts"}],[2510,{"../snaps/index.cjs":2499,"@metamask/rpc-errors":2421,"@metamask/snaps-utils":2713,"@metamask/utils":2835,nanoid:4749},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){function s(e,t,n){a(e,t),t.set(e,n)}function a(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var s=n.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){return e.get(c(e,t))}function o(e,t,n){return e.set(c(e,t),n),n}function c(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}Object.defineProperty(n,"__esModule",{value:!0}),n.WebSocketService=void 0;const l=e("@metamask/rpc-errors"),u=e("@metamask/snaps-utils"),d=e("@metamask/utils"),p=e("nanoid"),h=e("../snaps/index.cjs"),m="WebSocketService";var f=new WeakMap,g=new WeakMap,y=new WeakSet;function S(e,t){const n=r(g,this).get(t);return(0,d.assert)(n&&n.snapId===e,`Socket with ID "${t}" not found.`),n}function v(e,t,n){return c(y,this,k).call(this,e).some(e=>e.url===t&&(0,u.isEqual)(e.protocols,n))}function b(e,t){r(f,this).call("SnapController:handleRequest",{origin:h.METAMASK_ORIGIN,snapId:e,handler:u.HandlerType.OnWebSocketEvent,request:{method:"",params:{event:t}}}).catch(t=>{(0,u.logError)(`An error occurred while handling a WebSocket message for Snap "${e}":`,t)})}async function T(e,t,n=[]){(0,d.assert)(!c(y,this,v).call(this,e,t,n),`An open WebSocket connection to ${t} already exists.`);const s=new URL(t),{origin:a}=s,i=(0,p.nanoid)(),o=new WebSocket(t,n);o.binaryType="arraybuffer";const{promise:u,resolve:h,reject:m}=(0,d.createDeferredPromise)();o.addEventListener("open",()=>{h(),c(y,this,b).call(this,e,{type:"open",id:i,origin:a})}),o.addEventListener("close",t=>{r(g,this).delete(i),c(y,this,b).call(this,e,{type:"close",id:i,origin:a,code:t.code,reason:t.reason,wasClean:t.wasClean??null})});const f=()=>{m(l.rpcErrors.resourceUnavailable("An error occurred while opening the WebSocket."))};return o.addEventListener("error",f),o.addEventListener("message",t=>{const n="string"==typeof t.data?{type:"text",message:t.data}:{type:"binary",message:Array.from(new Uint8Array(t.data))};c(y,this,b).call(this,e,{type:"message",id:i,origin:a,data:n})}),r(g,this).set(i,{id:i,snapId:e,url:t,protocols:n,socket:o,openPromise:u}),await u,o.removeEventListener("error",f),i}function w(e,t){const{socket:n}=c(y,this,S).call(this,e,t);n.close()}function _(e){for(const t of c(y,this,k).call(this,e))c(y,this,w).call(this,e,t.id)}async function E(e,t,n){const{socket:s,openPromise:a}=c(y,this,S).call(this,e,t);await a;const i=Array.isArray(n)?new Uint8Array(n):n;s.send(i)}function k(e){return[...r(g,this).values()].filter(t=>t.snapId===e).map(e=>({id:e.id,url:e.url,protocols:e.protocols}))}n.WebSocketService=class{constructor({messenger:e}){var t,n;a(t=this,n=y),n.add(t),i(this,"name",m),i(this,"state",null),s(this,f,void 0),s(this,g,void 0),o(f,this,e),o(g,this,new Map),r(f,this).registerActionHandler(`${m}:open`,async(...e)=>c(y,this,T).call(this,...e)),r(f,this).registerActionHandler(`${m}:close`,(...e)=>c(y,this,w).call(this,...e)),r(f,this).registerActionHandler(`${m}:sendMessage`,async(...e)=>c(y,this,E).call(this,...e)),r(f,this).registerActionHandler(`${m}:getAll`,(...e)=>c(y,this,k).call(this,...e)),r(f,this).subscribe("SnapController:snapUpdated",e=>{c(y,this,_).call(this,e.id)}),r(f,this).subscribe("SnapController:snapUninstalled",e=>{c(y,this,_).call(this,e.id)}),r(f,this).subscribe("SnapController:snapInstalled",e=>{c(y,this,_).call(this,e.id)})}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/websocket/WebSocketService.cjs"}],[2511,{"./WebSocketService.cjs":2510},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){var s=Object.create?function(e,t,n,s){s===undefined&&(s=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,a)}:function(e,t,n,s){s===undefined&&(s=n),e[s]=t[n]},a=function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(n,"__esModule",{value:!0}),a(e("./WebSocketService.cjs"),n)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/websocket/index.cjs"}],[2512,{buffer:3793,"buffer-from":3799,inherits:4361,"readable-stream":5008,typedarray:5355},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){(function(n){(function(){var s=e("readable-stream").Writable,a=e("inherits"),i=e("buffer-from");if("undefined"==typeof Uint8Array)var r=e("typedarray").Uint8Array;else r=Uint8Array;function o(e,t){if(!(this instanceof o))return new o(e,t);"function"==typeof e&&(t=e,e={}),e||(e={});var n=e.encoding,a=!1;n?"u8"!==(n=String(n).toLowerCase())&&"uint8"!==n||(n="uint8array"):a=!0,s.call(this,{objectMode:!0}),this.encoding=n,this.shouldInferEncoding=a,t&&this.on("finish",function(){t(this.getBody())}),this.body=[]}t.exports=o,a(o,s),o.prototype._write=function(e,t,n){this.body.push(e),n()},o.prototype.inferEncoding=function(e){var t=e===undefined?this.body[0]:e;return n.isBuffer(t)?"buffer":"undefined"!=typeof Uint8Array&&t instanceof Uint8Array?"uint8array":Array.isArray(t)?"array":"string"==typeof t?"string":"[object Object]"===Object.prototype.toString.call(t)?"object":"buffer"},o.prototype.getBody=function(){return this.encoding||0!==this.body.length?(this.shouldInferEncoding&&(this.encoding=this.inferEncoding()),"array"===this.encoding?function(e){for(var t=[],n=0;n<e.length;n++)t.push.apply(t,e[n]);return t}(this.body):"string"===this.encoding?function(e){for(var t=[],s=0;s<e.length;s++){var a=e[s];"string"==typeof a||n.isBuffer(a)?t.push(a):c(a)?t.push(i(a)):t.push(i(String(a)))}t=n.isBuffer(e[0])?(t=n.concat(t)).toString("utf8"):t.join("");return t}(this.body):"buffer"===this.encoding?function(e){for(var t=[],s=0;s<e.length;s++){var a=e[s];n.isBuffer(a)?t.push(a):c(a)?t.push(i(a)):t.push(i(String(a)))}return n.concat(t)}(this.body):"uint8array"===this.encoding?function(e){for(var t=0,n=0;n<e.length;n++)"string"==typeof e[n]&&(e[n]=i(e[n])),t+=e[n].length;for(var s=new r(t),a=(n=0,0);n<e.length;n++)for(var o=e[n],c=0;c<o.length;c++)s[a++]=o[c];return s}(this.body):this.body):[]};Array.isArray;function c(e){return"string"==typeof e||(t=e,/Array\]$/.test(Object.prototype.toString.call(t)))||e&&"function"==typeof e.subarray;var t}}).call(this)}).call(this,e("buffer").Buffer)}}},{package:"@metamask/snaps-controllers>concat-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/concat-stream/index.js"}],[2513,{fs:3745},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){const s={S_IFMT:61440,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960};try{t.exports=e("fs").constants||s}catch{t.exports=s}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/constants.js"}],[2514,{"./headers":2515,b4a:3673,"fast-fifo":4136,streamx:5332},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){const{Writable:s,Readable:a,getStreamError:i}=e("streamx"),r=e("fast-fifo"),o=e("b4a"),c=e("./headers"),l=o.alloc(0);class u{constructor(){this.buffered=0,this.shifted=0,this.queue=new r,this._offset=0}push(e){this.buffered+=e.byteLength,this.queue.push(e)}shiftFirst(e){return 0===this._buffered?null:this._next(e)}shift(e){if(e>this.buffered)return null;if(0===e)return l;let t=this._next(e);if(e===t.byteLength)return t;const n=[t];for(;(e-=t.byteLength)>0;)t=this._next(e),n.push(t);return o.concat(n)}_next(e){const t=this.queue.peek(),n=t.byteLength-this._offset;if(e>=n){const e=this._offset?t.subarray(this._offset,t.byteLength):t;return this.queue.shift(),this._offset=0,this.buffered-=n,this.shifted+=n,e}return this.buffered-=e,this.shifted+=e,t.subarray(this._offset,this._offset+=e)}}class d extends a{constructor(e,t,n){super(),this.header=t,this.offset=n,this._parent=e}_read(e){0===this.header.size&&this.push(null),this._parent._stream===this&&this._parent._update(),e(null)}_predestroy(){this._parent.destroy(i(this))}_detach(){this._parent._stream===this&&(this._parent._stream=null,this._parent._missing=m(this.header.size),this._parent._update())}_destroy(e){this._detach(),e(null)}}class p extends s{constructor(e){super(e),e||(e={}),this._buffer=new u,this._offset=0,this._header=null,this._stream=null,this._missing=0,this._longHeader=!1,this._callback=h,this._locked=!1,this._finished=!1,this._pax=null,this._paxGlobal=null,this._gnuLongPath=null,this._gnuLongLinkPath=null,this._filenameEncoding=e.filenameEncoding||"utf-8",this._allowUnknownFormat=!!e.allowUnknownFormat,this._unlockBound=this._unlock.bind(this)}_unlock(e){if(this._locked=!1,e)return this.destroy(e),void this._continueWrite(e);this._update()}_consumeHeader(){if(this._locked)return!1;this._offset=this._buffer.shifted;try{this._header=c.decode(this._buffer.shift(512),this._filenameEncoding,this._allowUnknownFormat)}catch(e){return this._continueWrite(e),!1}if(!this._header)return!0;switch(this._header.type){case"gnu-long-path":case"gnu-long-link-path":case"pax-global-header":case"pax-header":return this._longHeader=!0,this._missing=this._header.size,!0}return this._locked=!0,this._applyLongHeaders(),0===this._header.size||"directory"===this._header.type?(this.emit("entry",this._header,this._createStream(),this._unlockBound),!0):(this._stream=this._createStream(),this._missing=this._header.size,this.emit("entry",this._header,this._stream,this._unlockBound),!0)}_applyLongHeaders(){this._gnuLongPath&&(this._header.name=this._gnuLongPath,this._gnuLongPath=null),this._gnuLongLinkPath&&(this._header.linkname=this._gnuLongLinkPath,this._gnuLongLinkPath=null),this._pax&&(this._pax.path&&(this._header.name=this._pax.path),this._pax.linkpath&&(this._header.linkname=this._pax.linkpath),this._pax.size&&(this._header.size=parseInt(this._pax.size,10)),this._header.pax=this._pax,this._pax=null)}_decodeLongHeader(e){switch(this._header.type){case"gnu-long-path":this._gnuLongPath=c.decodeLongPath(e,this._filenameEncoding);break;case"gnu-long-link-path":this._gnuLongLinkPath=c.decodeLongPath(e,this._filenameEncoding);break;case"pax-global-header":this._paxGlobal=c.decodePax(e);break;case"pax-header":this._pax=null===this._paxGlobal?c.decodePax(e):Object.assign({},this._paxGlobal,c.decodePax(e))}}_consumeLongHeader(){this._longHeader=!1,this._missing=m(this._header.size);const e=this._buffer.shift(this._header.size);try{this._decodeLongHeader(e)}catch(e){return this._continueWrite(e),!1}return!0}_consumeStream(){const e=this._buffer.shiftFirst(this._missing);if(null===e)return!1;this._missing-=e.byteLength;const t=this._stream.push(e);return 0===this._missing?(this._stream.push(null),t&&this._stream._detach(),t&&!1===this._locked):t}_createStream(){return new d(this,this._header,this._offset)}_update(){for(;this._buffer.buffered>0&&!this.destroying;){if(this._missing>0){if(null!==this._stream){if(!1===this._consumeStream())return;continue}if(!0===this._longHeader){if(this._missing>this._buffer.buffered)break;if(!1===this._consumeLongHeader())return!1;continue}const e=this._buffer.shiftFirst(this._missing);null!==e&&(this._missing-=e.byteLength);continue}if(this._buffer.buffered<512)break;if(null!==this._stream||!1===this._consumeHeader())return}this._continueWrite(null)}_continueWrite(e){const t=this._callback;this._callback=h,t(e)}_write(e,t){this._callback=t,this._buffer.push(e),this._update()}_final(e){this._finished=0===this._missing&&0===this._buffer.buffered,e(this._finished?null:new Error("Unexpected end of data"))}_predestroy(){this._continueWrite(null)}_destroy(e){this._stream&&this._stream.destroy(i(this)),e(null)}[Symbol.asyncIterator](){let e=null,t=null,n=null,s=null,a=null;const i=this;return this.on("entry",function(e,i,r){a=r,i.on("error",h),t?(t({value:i,done:!1}),t=n=null):s=i}),this.on("error",t=>{e=t}),this.on("close",function(){if(r(e),!t)return;e?n(e):t({value:undefined,done:!0});t=n=null}),{[Symbol.asyncIterator](){return this},next:()=>new Promise(o),return:()=>c(null),throw:e=>c(e)};function r(e){if(!a)return;const t=a;a=null,t(e)}function o(a,o){return e?o(e):s?(a({value:s,done:!1}),void(s=null)):(t=a,n=o,r(null),void(i._finished&&t&&(t({value:undefined,done:!0}),t=n=null)))}function c(e){return i.destroy(e),r(e),new Promise((t,n)=>{if(i.destroyed)return t({value:undefined,done:!0});i.once("close",function(){e?n(e):t({value:undefined,done:!0})})})}}}function h(){}function m(e){return(e&=511)&&512-e}t.exports=function(e){return new p(e)}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/extract.js"}],[2515,{b4a:3673},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){const s=e("b4a"),a="0".charCodeAt(0),i=s.from([117,115,116,97,114,0]),r=s.from([a,a]),o=s.from([117,115,116,97,114,32]),c=s.from([32,0]),l=257,u=263;function d(e,t,n,s){for(;n<s;n++)if(e[n]===t)return n;return s}function p(e){let t=256;for(let n=0;n<148;n++)t+=e[n];for(let n=156;n<512;n++)t+=e[n];return t}function h(e,t){return(e=e.toString(8)).length>t?"7777777777777777777".slice(0,t)+" ":"0000000000000000000".slice(0,t-e.length)+e+" "}function m(e,t,n){if(128&(e=e.subarray(t,t+n))[t=0])return function(e){let t;if(128===e[0])t=!0;else{if(255!==e[0])return null;t=!1}const n=[];let s;for(s=e.length-1;s>0;s--){const a=e[s];t?n.push(a):n.push(255-a)}let a=0;const i=n.length;for(s=0;s<i;s++)a+=n[s]*Math.pow(256,s);return t?a:-1*a}(e);{for(;t<e.length&&32===e[t];)t++;const n=(a=d(e,32,t,e.length),i=e.length,r=e.length,"number"!=typeof a?r:(a=~~a)>=i?i:a>=0||(a+=i)>=0?a:0);for(;t<n&&0===e[t];)t++;return n===t?0:parseInt(s.toString(e.subarray(t,n)),8)}var a,i,r}function f(e,t,n,a){return s.toString(e.subarray(t,d(e,0,t,t+n)),a)}function g(e){const t=s.byteLength(e);let n=Math.floor(Math.log(t)/Math.log(10))+1;return t+n>=Math.pow(10,n)&&n++,t+n+e}n.decodeLongPath=function(e,t){return f(e,0,e.length,t)},n.encodePax=function(e){let t="";e.name&&(t+=g(" path="+e.name+"\n")),e.linkname&&(t+=g(" linkpath="+e.linkname+"\n"));const n=e.pax;if(n)for(const e in n)t+=g(" "+e+"="+n[e]+"\n");return s.from(t)},n.decodePax=function(e){const t={};for(;e.length;){let n=0;for(;n<e.length&&32!==e[n];)n++;const a=parseInt(s.toString(e.subarray(0,n)),10);if(!a)return t;const i=s.toString(e.subarray(n+1,a-1)),r=i.indexOf("=");if(-1===r)return t;t[i.slice(0,r)]=i.slice(r+1),e=e.subarray(a)}return t},n.encode=function(e){const t=s.alloc(512);let n=e.name,o="";if(5===e.typeflag&&"/"!==n[n.length-1]&&(n+="/"),s.byteLength(n)!==n.length)return null;for(;s.byteLength(n)>100;){const e=n.indexOf("/");if(-1===e)return null;o+=o?"/"+n.slice(0,e):n.slice(0,e),n=n.slice(e+1)}return s.byteLength(n)>100||s.byteLength(o)>155||e.linkname&&s.byteLength(e.linkname)>100?null:(s.write(t,n),s.write(t,h(4095&e.mode,6),100),s.write(t,h(e.uid,6),108),s.write(t,h(e.gid,6),116),function(e,t,n){e.toString(8).length>11?function(e,t,n){t[n]=128;for(let s=11;s>0;s--)t[n+s]=255&e,e=Math.floor(e/256)}(e,t,n):s.write(t,h(e,11),n)}(e.size,t,124),s.write(t,h(e.mtime.getTime()/1e3|0,11),136),t[156]=a+function(e){switch(e){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72}return 0}(e.type),e.linkname&&s.write(t,e.linkname,157),s.copy(i,t,l),s.copy(r,t,263),e.uname&&s.write(t,e.uname,265),e.gname&&s.write(t,e.gname,297),s.write(t,h(e.devmajor||0,6),329),s.write(t,h(e.devminor||0,6),337),o&&s.write(t,o,345),s.write(t,h(p(t),6),148),t)},n.decode=function(e,t,n){let r=0===e[156]?0:e[156]-a,d=f(e,0,100,t);const h=m(e,100,8),g=m(e,108,8),y=m(e,116,8),S=m(e,124,12),v=m(e,136,12),b=function(e){switch(e){case 0:return"file";case 1:return"link";case 2:return"symlink";case 3:return"character-device";case 4:return"block-device";case 5:return"directory";case 6:return"fifo";case 7:return"contiguous-file";case 72:return"pax-header";case 55:return"pax-global-header";case 27:return"gnu-long-link-path";case 28:case 30:return"gnu-long-path"}return null}(r),T=0===e[157]?null:f(e,157,100,t),w=f(e,265,32),_=f(e,297,32),E=m(e,329,8),k=m(e,337,8),P=p(e);if(256===P)return null;if(P!==m(e,148,8))throw new Error("Invalid tar header. Maybe the tar is corrupted or it needs to be gunzipped?");if(function(e){return s.equals(i,e.subarray(l,263))}(e))e[345]&&(d=f(e,345,155,t)+"/"+d);else if(function(e){return s.equals(o,e.subarray(l,263))&&s.equals(c,e.subarray(u,265))}(e));else if(!n)throw new Error("Invalid tar header: unknown format.");return 0===r&&d&&"/"===d[d.length-1]&&(r=5),{name:d,mode:h,uid:g,gid:y,size:S,mtime:new Date(1e3*v),type:b,linkname:T,uname:w,gname:_,devmajor:E,devminor:k,pax:null}}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/headers.js"}],[2516,{"./extract":2514,"./pack":2517},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){n.extract=e("./extract"),n.pack=e("./pack")}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/index.js"}],[2517,{"./constants":2513,"./headers":2515,b4a:3673,streamx:5332},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){const{Readable:s,Writable:a,getStreamError:i}=e("streamx"),r=e("b4a"),o=e("./constants"),c=e("./headers"),l=r.alloc(1024);class u extends a{constructor(e,t,n){super({mapWritable:m,eagerOpen:!0}),this.written=0,this.header=t,this._callback=n,this._linkname=null,this._isLinkname="symlink"===t.type&&!t.linkname,this._isVoid="file"!==t.type&&"contiguous-file"!==t.type,this._finished=!1,this._pack=e,this._openCallback=null,null===this._pack._stream?this._pack._stream=this:this._pack._pending.push(this)}_open(e){this._openCallback=e,this._pack._stream===this&&this._continueOpen()}_continuePack(e){if(null===this._callback)return;const t=this._callback;this._callback=null,t(e)}_continueOpen(){null===this._pack._stream&&(this._pack._stream=this);const e=this._openCallback;if(this._openCallback=null,null!==e){if(this._pack.destroying)return e(new Error("pack stream destroyed"));if(this._pack._finalized)return e(new Error("pack stream is already finalized"));this._pack._stream=this,this._isLinkname||this._pack._encode(this.header),this._isVoid&&(this._finish(),this._continuePack(null)),e(null)}}_write(e,t){return this._isLinkname?(this._linkname=this._linkname?r.concat([this._linkname,e]):e,t(null)):this._isVoid?e.byteLength>0?t(new Error("No body allowed for this entry")):t():(this.written+=e.byteLength,this._pack.push(e)?t():void(this._pack._drain=t))}_finish(){this._finished||(this._finished=!0,this._isLinkname&&(this.header.linkname=this._linkname?r.toString(this._linkname,"utf-8"):"",this._pack._encode(this.header)),h(this._pack,this.header.size),this._pack._done(this))}_final(e){if(this.written!==this.header.size)return e(new Error("Size mismatch"));this._finish(),e(null)}_getError(){return i(this)||new Error("tar entry destroyed")}_predestroy(){this._pack.destroy(this._getError())}_destroy(e){this._pack._done(this),this._continuePack(this._finished?null:this._getError()),e()}}class d extends s{constructor(e){super(e),this._drain=p,this._finalized=!1,this._finalizing=!1,this._pending=[],this._stream=null}entry(e,t,n){if(this._finalized||this.destroying)throw new Error("already finalized or destroyed");"function"==typeof t&&(n=t,t=null),n||(n=p),e.size&&"symlink"!==e.type||(e.size=0),e.type||(e.type=function(e){switch(e&o.S_IFMT){case o.S_IFBLK:return"block-device";case o.S_IFCHR:return"character-device";case o.S_IFDIR:return"directory";case o.S_IFIFO:return"fifo";case o.S_IFLNK:return"symlink"}return"file"}(e.mode)),e.mode||(e.mode="directory"===e.type?493:420),e.uid||(e.uid=0),e.gid||(e.gid=0),e.mtime||(e.mtime=new Date),"string"==typeof t&&(t=r.from(t));const s=new u(this,e,n);return r.isBuffer(t)?(e.size=t.byteLength,s.write(t),s.end(),s):(s._isVoid,s)}finalize(){this._stream||this._pending.length>0?this._finalizing=!0:this._finalized||(this._finalized=!0,this.push(l),this.push(null))}_done(e){e===this._stream&&(this._stream=null,this._finalizing&&this.finalize(),this._pending.length&&this._pending.shift()._continueOpen())}_encode(e){if(!e.pax){const t=c.encode(e);if(t)return void this.push(t)}this._encodePax(e)}_encodePax(e){const t=c.encodePax({name:e.name,linkname:e.linkname,pax:e.pax}),n={name:"PaxHeader",mode:e.mode,uid:e.uid,gid:e.gid,size:t.byteLength,mtime:e.mtime,type:"pax-header",linkname:e.linkname&&"PaxHeader",uname:e.uname,gname:e.gname,devmajor:e.devmajor,devminor:e.devminor};this.push(c.encode(n)),this.push(t),h(this,t.byteLength),n.size=e.size,n.type=e.type,this.push(c.encode(n))}_doDrain(){const e=this._drain;this._drain=p,e()}_predestroy(){const e=i(this);for(this._stream&&this._stream.destroy(e);this._pending.length;){const t=this._pending.shift();t.destroy(e),t._continueOpen()}this._doDrain()}_read(e){this._doDrain(),e()}}function p(){}function h(e,t){(t&=511)&&e.push(l.subarray(0,512-t))}function m(e){return r.isBuffer(e)?e:r.from(e)}t.exports=function(e){return new d(e)}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/pack.js"}],[2522,{"./verify":2523,"@metamask/superstruct":2741,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){s===undefined&&(s=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,a)}:function(e,t,n,s){s===undefined&&(s=n),e[s]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(n,"__esModule",{value:!0}),n.SnapsRegistryDatabaseStruct=n.BlockedSnapStruct=n.BlockReasonStruct=n.VerifiedSnapStruct=n.ImagePathStruct=n.AdditionalSourceCodeStruct=n.SupportStruct=n.AuditStruct=n.AuthorStruct=void 0;const i=e("@metamask/superstruct"),r=e("@metamask/utils"),o=(0,i.refine)((0,i.string)(),"Npm ID",e=>e.startsWith("npm:")),c=(0,i.object)({checksum:r.ChecksumStruct});n.AuthorStruct=(0,i.object)({name:(0,i.string)(),website:(0,i.string)()}),n.AuditStruct=(0,i.object)({auditor:(0,i.string)(),report:(0,i.string)()}),n.SupportStruct=(0,i.object)({knowledgeBase:(0,i.optional)((0,i.string)()),faq:(0,i.optional)((0,i.string)()),contact:(0,i.optional)((0,i.string)()),keyRecovery:(0,i.optional)((0,i.string)())}),n.AdditionalSourceCodeStruct=(0,i.object)({name:(0,i.string)(),url:(0,i.string)()}),n.ImagePathStruct=(0,i.pattern)((0,i.string)(),/\.\/images\/.*\/\d+\.(?:png|jpe?g)$/u),n.VerifiedSnapStruct=(0,i.object)({id:o,metadata:(0,i.object)({name:(0,i.string)(),type:(0,i.optional)((0,i.enums)(["account"])),author:(0,i.optional)(n.AuthorStruct),website:(0,i.optional)((0,i.string)()),onboard:(0,i.optional)((0,i.boolean)()),summary:(0,i.optional)((0,i.string)()),description:(0,i.optional)((0,i.string)()),audits:(0,i.optional)((0,i.array)(n.AuditStruct)),category:(0,i.optional)((0,i.enums)(["interoperability","notifications","transaction insights","account management","name resolution"])),tags:(0,i.optional)((0,i.array)((0,i.string)())),support:(0,i.optional)(n.SupportStruct),sourceCode:(0,i.optional)((0,i.string)()),hidden:(0,i.optional)((0,i.boolean)()),privateCode:(0,i.optional)((0,i.boolean)()),privacyPolicy:(0,i.optional)((0,i.string)()),termsOfUse:(0,i.optional)((0,i.string)()),additionalSourceCode:(0,i.optional)((0,i.array)(n.AdditionalSourceCodeStruct)),screenshots:(0,i.optional)((0,i.size)((0,i.array)(n.ImagePathStruct),3,3))}),versions:(0,i.record)(r.VersionStruct,c)}),n.BlockReasonStruct=(0,i.object)({explanation:(0,i.optional)((0,i.string)()),url:(0,i.optional)((0,i.string)())}),n.BlockedSnapStruct=(0,i.union)([(0,i.object)({id:o,versionRange:r.VersionRangeStruct,reason:(0,i.optional)(n.BlockReasonStruct)}),(0,i.object)({checksum:r.ChecksumStruct,reason:(0,i.optional)(n.BlockReasonStruct)})]),n.SnapsRegistryDatabaseStruct=(0,i.object)({verifiedSnaps:(0,i.record)(o,n.VerifiedSnapStruct),blockedSnaps:(0,i.array)(n.BlockedSnapStruct)}),a(e("./verify"),n)}}},{package:"@metamask/snaps-utils>@metamask/snaps-registry",file:"node_modules/@metamask/snaps-registry/dist/index.js"}],[2523,{"@metamask/superstruct":2741,"@metamask/utils":2835,"@noble/curves/secp256k1":2876,"@noble/hashes/sha256":2888},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.verify=n.SignatureStruct=void 0;const s=e("@metamask/superstruct"),a=e("@metamask/utils"),i=e("@noble/curves/secp256k1"),r=e("@noble/hashes/sha256");n.SignatureStruct=(0,s.object)({signature:a.StrictHexStruct,curve:(0,s.literal)("secp256k1"),format:(0,s.literal)("DER")}),n.verify=function({registry:e,signature:t,publicKey:s}){(0,a.assertStruct)(t,n.SignatureStruct,"Invalid signature object");const o=(0,a.hexToBytes)(s);return i.secp256k1.verify((0,a.remove0x)(t.signature),(0,r.sha256)((0,a.stringToBytes)(e)),o)}}}},{package:"@metamask/snaps-utils>@metamask/snaps-registry",file:"node_modules/@metamask/snaps-registry/dist/verify.js"}],[257,{"../../../../../shared/lib/delegation":5524,"../../../../../shared/lib/delegation/delegation":5521,"@metamask/transaction-controller":2790,"@metamask/utils":2835,"bignumber.js":3684},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.enforceSimulations=async function({messenger:e,transactionMeta:t,useRealSignature:n=!1}){c("Enforcing simulations",{transactionMeta:t,useRealSignature:n});const{chainId:i,simulationData:d={tokenBalanceChanges:[]},txParams:p}=t,h=p.from,m=(0,a.hexToNumber)(i),f=(0,r.getDeleGatorEnvironment)(m),g=f.DelegationManager,y=function(e,t){const n=e.call("AppStateController:getState"),s=n.enforcedSimulationsSlippage;return n.enforcedSimulationsSlippageForTransactions[t]??s}(e,t.id),S=function({accountAddress:e,environment:t,simulationData:n,slippage:a}){const i=function(e,t,n,a){const i=(0,r.createCaveatBuilder)(t),{nativeBalanceChange:o,tokenBalanceChanges:l=[]}=n;if(o){const{difference:t,isDecrease:n}=o,s=u(t,a,n);c("Caveat - Native Balance Change",{enforceDecrease:n,recipient:e,delta:BigInt(t),slippage:a,deltaWithSlippage:s}),i.addCaveat("nativeBalanceChange",n,e,s)}for(const t of l){const{difference:n,isDecrease:r,address:o,standard:l,id:d}=t,p=BigInt(n),h=u(n,a,r),m=d?BigInt(d):0n;switch(c("Caveat - Token Balance Change",{enforceDecrease:r,token:o,recipient:e,delta:p,slippage:a,deltaWithSlippage:h}),l){case s.SimulationTokenStandard.erc20:i.addCaveat("erc20BalanceChange",r,o,e,h);break;case s.SimulationTokenStandard.erc721:i.addCaveat("erc721BalanceChange",r,o,e,p);break;case s.SimulationTokenStandard.erc1155:i.addCaveat("erc1155BalanceChange",r,o,e,m,p);break;default:c("Unsupported token standard",l)}}return i.build()}(e,t,n,a);c("Caveats",i);const o=(0,r.createDelegation)({from:e,to:e,caveats:i});return o}({accountAddress:h,environment:f,simulationData:d,slippage:y});c("Delegation",S);let v=l;n&&(c("Signing delegation"),v=await e.call("DelegationController:signDelegation",{chainId:i,delegation:S}));c("Delegation signature",v);const b=function({transaction:e,delegation:t}){const n=[[t]],s=[r.SINGLE_DEFAULT_MODE],a=[[{target:e.to,callData:e.data??"0x",value:e.value?BigInt(e.value):0n}]];return(0,o.encodeRedeemDelegations)({delegations:n,modes:s,executions:a})}({transaction:p,delegation:{...S,signature:v}});return c("Data",b),{updateTransaction:e=>{e.txParams.data=b,e.txParams.to=g,e.txParams.value="0x0"}}};var s=e("@metamask/transaction-controller"),a=e("@metamask/utils"),i=e("bignumber.js"),r=e("../../../../../shared/lib/delegation"),o=e("../../../../../shared/lib/delegation/delegation");const c=(0,a.createProjectLogger)("enforced-simulations"),l="0x2261a7810ed3e9cde160895909e138e2f68adb2da86fcf98ea0840701df107721fb369ab9b52550ea98832c09f8185284aca4c94bd345e867a4f4461868dd7751b";function u(e,t,n){const s=new i.BigNumber(e),a=(100+(n?t:-t))/100;return BigInt(s.mul(a).toFixed(0))}}}},{package:"$root$",file:"app/scripts/lib/transaction/containers/enforced-simulations.ts"}],[258,{"./enforced-simulations":257,"@metamask/transaction-controller":2790,"@metamask/utils":2835,lodash:4565},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.applyTransactionContainers=c,n.applyTransactionContainersExisting=async function({containerTypes:e,transactionId:t,messenger:n,updateEditableParams:s}){const i=(await n.call("TransactionController:getState")).transactions.find(e=>e.id===t);if(!i)throw new Error(`Transaction with ID ${t} not found.`);const{updateTransaction:r}=await c({isApproved:!1,messenger:n,transactionMeta:i,types:e}),o=(0,a.cloneDeep)(i);r(o),s(t,{containerTypes:e,data:o.txParams.data,gas:o.txParams.gas,to:o.txParams.to,value:o.txParams.value})};var s=e("@metamask/transaction-controller"),a=e("lodash"),i=e("@metamask/utils"),r=e("./enforced-simulations");const o=(0,i.createProjectLogger)("transaction-containers");async function c({isApproved:e,messenger:t,transactionMeta:n,types:i}){const{txParamsOriginal:c}=n,l=(0,a.cloneDeep)(n);if(c&&(l.txParams=(0,a.cloneDeep)(c)),i.includes(s.TransactionContainerType.EnforcedSimulations)){const{updateTransaction:n}=await(0,r.enforceSimulations)({messenger:t,transactionMeta:l,useRealSignature:e});n(l)}let u;if(!e){const{gas:e}=await t.call("TransactionController:estimateGas",l.txParams,l.networkClientId,{ignoreDelegationSignatures:!0});o("Estimated gas",e),u=e}return{updateTransaction:e=>{e.containerTypes=i,e.txParams=(0,a.cloneDeep)(l.txParams),u&&(e.txParams.gas=u)}}}}}},{package:"$root$",file:"app/scripts/lib/transaction/containers/util.ts"}],[259,{"../../../../../shared/lib/four-byte":5528,"@ethersproject/abi":612,"@metamask/utils":2835,"ethereumjs-util":4052},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.decodeTransactionDataWithFourByte=async function(e){const t=e.slice(0,10),n=await(0,r.getMethodFrom4Byte)(t);if(!n)return undefined;const i=n.split("(")[0],d=function(e){let t=e.slice(e.indexOf("(")+1,-1);const n=[];for(;t.includes("(");){const e=u(t);if(!e)break;n.push(e.value),t=`${t.slice(0,e.start)}${n.length-1}#${t.slice(e.end+1)}`}return l(t,n)}(n);o("Generated inputs",d);const p=(0,s.addHexPrefix)(e.slice(10)),h=a.Interface.getAbiCoder().decode(d,p),m=d.map((e,t)=>c(e,t,h));return{name:i,params:m}};var s=e("ethereumjs-util"),a=e("@ethersproject/abi"),i=e("@metamask/utils"),r=e("../../../../../shared/lib/four-byte");const o=(0,i.createProjectLogger)("four-byte");function c(e,t,n){var s;const a=n[t],{type:i,name:r}=e;let o=null===(s=e.components)||void 0===s?void 0:s.map((e,t)=>c(e,t,a));if(i.endsWith("[]")){const t=i.slice(0,-2);o=a.map((n,s)=>{const i=`Item ${s+1}`;return c({...e,name:i,type:t},s,a)})}return{name:r,type:i,value:a,children:o}}function l(e,t){return e.split(",").map(e=>{const n=e.split("#"),s=n.length>1?parseInt(n[0],10):undefined;return{type:s===undefined?e:`tuple${n[1]??""}`,components:s===undefined?undefined:l(t[s],t)}})}function u(e){let t=-1;for(let n=0;n<e.length;n++)if("("===e[n])t=n;else if(")"===e[n]&&-1!==t)return{start:t,end:n,value:e.slice(t+1,n)};return undefined}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/four-byte.ts"}],[26,{"@metamask/assets-controllers":1138},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.CurrencyRateControllerInit=void 0;var s=e("@metamask/assets-controllers");n.CurrencyRateControllerInit=({controllerMessenger:e,initMessenger:t,persistedState:n})=>{const a=new s.CurrencyRateController({state:n.CurrencyController,messenger:e,includeUsdRate:!0,useExternalServices:()=>t.call("PreferencesController:getState").useExternalServices}),i=a.fetchMultiExchangeRate.bind(a);return a.fetchMultiExchangeRate=(...e)=>{const{useCurrencyRateCheck:n}=t.call("PreferencesController:getState");return n?i(...e):{conversionRate:null,usdConversionRate:null}},{memStateKey:"CurrencyController",persistedStateKey:"CurrencyController",controller:a}}}}},{package:"$root$",file:"app/scripts/controller-init/currency-rate-controller-init.ts"}],[260,{"ethereumjs-util":4052},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.getContractProxyAddress=async function(e,t){const n=(await Promise.all(a.map(n=>t.request({method:"eth_getStorageAt",params:[e,n,"latest"]})))).find(e=>(0,s.stripHexPrefix)(e)!==i);return n&&(0,s.addHexPrefix)(n.slice(26))};var s=e("ethereumjs-util");const a=["0x7050c9e0f4ca769c69bd3a8ef740bc37934f8e2c036e5a723fd8ee048ed3f8c3","0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc"],i="0".padEnd(64,"0")}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/proxy.ts"}],[261,{"@ethersproject/abi":612,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.decodeTransactionDataWithSourcify=async function(e,t,n){var o,c;const l=await async function(e,t){var n;const s=await async function(e,t){const n=parseInt(t,16),s=await fetch(`https://sourcify.dev/server/files/any/${n}/${e}`);if(!s.ok)throw new Error("Failed to fetch Sourcify files");return s.json()}(e,t),a=null===(n=s.files)||void 0===n?void 0:n.find(e=>e.name.includes("metadata.json"));if(!a)throw new Error("Metadata not found");return JSON.parse(a.content)}(t,n);a("Retrieved Sourcify metadata",{contractAddress:t,chainId:n,metadata:l});const{abi:u}=l.output,d=new s.Interface(u),p=e.slice(0,10);let h;try{h=d.getFunction(p)}catch(e){}if(!h)return a("Failed to find function in ABI",p,u),undefined;const{name:m,inputs:f}=h,g=r(m,f),y=null===(o=l.output.userdoc)||void 0===o?void 0:o.methods[g],S=null===(c=l.output.devdoc)||void 0===c?void 0:c.methods[g],v=(null==y?void 0:y.notice)??(null==S?void 0:S.details);a("Extracted NatSpec",{signature:g,userDoc:y,devDoc:S});const b=d.decodeFunctionData(p,e),T=f.map((e,t)=>i(e,t,b,y,S));return{name:m,description:v,params:T}};var s=e("@ethersproject/abi");const a=(0,e("@metamask/utils").createProjectLogger)("sourcify");function i(e,t,n,s,a){var r,o;const{name:c,type:l,components:u}=e,d=(null==s||null===(r=s.params)||void 0===r?void 0:r[c])??(null==a||null===(o=a.params)||void 0===o?void 0:o[c]),p=n[t];let h=null==u?void 0:u.map((e,t)=>i(e,t,p,{},{}));if(l.endsWith("[]")){const t=l.slice(0,-2);h=p.map((n,s)=>{const a=`Item ${s+1}`;return i({...e,name:a,type:t},s,p,{},{})})}return{name:c,description:d,type:l,value:p,children:h}}function r(e,t){return`${e??""}(${t.map(e=>{var t;return null!==(t=e.components)&&void 0!==t&&t.length?`${r(undefined,e.components)}${e.type.endsWith("[]")?"[]":""}`:e.type}).join(",")})`}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/sourcify.ts"}],[262,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.UNISWAP_ROUTER_COMMANDS=void 0;n.UNISWAP_ROUTER_COMMANDS={0:{name:"V3_SWAP_EXACT_IN",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of input tokens for the trade",name:"amountIn"},{type:"uint256",description:"The minimum amount of output tokens the user wants",name:"amountOutMin"},{type:"bytes",description:"The UniswapV3 encoded path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},1:{name:"V3_SWAP_EXACT_OUT",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of output tokens to receive",name:"amountOut"},{type:"uint256",description:"The maximum number of input tokens that should be spent",name:"amountInMax"},{type:"bytes",description:"The UniswapV3 encoded path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},2:{name:"PERMIT2_TRANSFER_FROM",params:[{type:"address",description:"The token to fetch from Permit2",name:"token"},{type:"address",description:"The recipient of the tokens fetched",name:"recipient"},{type:"uint256",description:"The amount of token to fetch",name:"amount"}]},3:{name:"PERMIT2_PERMIT_BATCH",params:[{type:"bytes",description:"A PermitBatch struct outlining all of the Permit2 permits to execute.",name:"batch"},{type:"bytes",description:"The signature to provide to Permit2",name:"data"}]},4:{name:"SWEEP",params:[{type:"address",description:"The ERC20 token to sweep (or Constants.ETH for ETH)",name:"token"},{type:"address",description:"The recipient of the sweep",name:"recipient"},{type:"uint256",description:"The minimum required tokens to receive from the sweep",name:"amountMin"}]},5:{name:"TRANSFER",params:[{type:"address",description:"The ERC20 token to transfer (or Constants.ETH for ETH)",name:"token"},{type:"address",description:"The recipient of the transfer",name:"recipient"},{type:"uint256",description:"The amount to transfer",name:"value"}]},6:{name:"PAY_PORTION",params:[{type:"address",description:"The ERC20 token to transfer (or Constants.ETH for ETH)",name:"token"},{type:"address",description:"The recipient of the transfer",name:"recipient"},{type:"uint256",description:"In basis points, the percentage of the contracts balance to transfer",name:"bips"}]},8:{name:"V2_SWAP_EXACT_IN",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of input tokens for the trade",name:"amountIn"},{type:"uint256",description:"The minimum amount of output tokens the user wants",name:"amountOutMin"},{type:"address[]",description:"The UniswapV2 token path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},9:{name:"V2_SWAP_EXACT_OUT",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of output tokens to receive",name:"amountOut"},{type:"uint256",description:"The maximum number of input tokens that should be spent",name:"amountInMax"},{type:"address[]",description:"The UniswapV2 token path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},10:{name:"PERMIT2_PERMIT",params:[{type:"bytes",description:"A PermitSingle struct outlining the Permit2 permit to execute",name:"permitSingle"},{type:"bytes",description:"The signature to provide to Permit2",name:"signature"}]},11:{name:"WRAP_ETH",params:[{type:"address",description:"The recipient of the WETH",name:"recipient"},{type:"uint256",description:"The amount of ETH to wrap",name:"amountMin"}]},12:{name:"UNWRAP_WETH",params:[{type:"address",description:"The recipient of the ETH",name:"recipient"},{type:"uint256",description:"The minimum required ETH to receive from the unwrapping",name:"amountMin"}]},13:{name:"PERMIT2_TRANSFER_FROM_BATCH",params:[{type:"bytes",description:"An array of AllowanceTransferDetails structs that each describe a Permit2 transfer to perform",name:"batchDetails"}]},16:{name:"SEAPORT",params:[{type:"uint256",description:"The ETH value to forward to the Seaport contract",name:"value"},{type:"bytes",description:"The calldata to use to call the Seaport contract",name:"data"}]},17:{name:"LOOKS_RARE_721",params:[{type:"uint256",description:"The ETH value to forward to the LooksRare contract",name:"value"},{type:"bytes",description:"The calldata to use to call the LooksRare contract",name:"data"},{type:"address",description:"The recipient of the ERC721",name:"recipient"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},18:{name:"NFTX",params:[{type:"uint256",description:"The ETH value to forward to the NFTX contract",name:"value"},{type:"bytes",description:"The calldata to use to call the NFTX contract",name:"data"}]},19:{name:"CRYPTOPUNKS",params:[{type:"uint256",description:"The PunkID to purchase",name:"punkId"},{type:"address",description:"The recipient for the cryptopunk",name:"recipient"},{type:"uint256",description:"The ETH value to forward to the Cryptopunks contract",name:"value"}]},20:{name:"LOOKS_RARE_1155",params:[{type:"uint256",description:"The ETH value to forward to the LooksRare contract",name:"value"},{type:"bytes",description:"The calldata to use to call the LooksRare contract",name:"data"},{type:"address",description:"The recipient of the ERC1155",name:"recipient"},{type:"address",description:"The ERC1155 token address",name:"token"},{type:"uint256",description:"The ID of the ERC1155",name:"id"},{type:"uint256",description:"The amount of the ERC1155 to transfer",name:"amount"}]},21:{name:"OWNER_CHECK_721",params:[{type:"address",description:"The required owner of the ERC721",name:"owner"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},22:{name:"OWNER_CHECK_1155",params:[{type:"address",description:"The required owner of the ERC1155",name:"owner"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC1155",name:"id"},{type:"uint256",description:"The minimum required amount of the ERC1155",name:"minBalance"}]},23:{name:"SWEEP_ERC721",params:[{type:"address",description:"The ERC721 token address to transfer",name:"token"},{type:"address",description:"The recipient of the transfer",name:"recipient"},{type:"uint256",description:"The token ID to transfer",name:"id"}]},24:{name:"X2Y2_721",params:[{type:"uint256",description:"The ETH value to forward to the X2Y2 contract",name:"value"},{type:"bytes",description:"The calldata to use to call the X2Y2 contract",name:"data"},{type:"address",description:"The recipient of the ERC721",name:"recipient"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},25:{name:"SUDOSWAP",params:[{type:"uint256",description:"The ETH value to forward to the Sudoswap contract",name:"value"},{type:"bytes",description:"The calldata to use to call the Sudoswap contract",name:"data"}]},26:{name:"NFT20",params:[{type:"uint256",description:"The ETH value to forward to the NFT20 contract",name:"value"},{type:"bytes",description:"The calldata to use to call the NFT20 contract",name:"data"}]},27:{name:"X2Y2_1155",params:[{type:"uint256",description:"The ETH value to forward to the X2Y2 contract",name:"value"},{type:"bytes",description:"The calldata to use to call the X2Y2 contract",name:"data"},{type:"address",description:"The recipient of the ERC1155",name:"recipient"},{type:"address",description:"The ERC1155 token address",name:"token"},{type:"uint256",description:"The ID of the ERC1155",name:"id"},{type:"uint256",description:"The amount of the ERC1155 to transfer",name:"amount"}]},28:{name:"FOUNDATION",params:[{type:"uint256",description:"The ETH value to forward to the Foundation contract",name:"value"},{type:"bytes",description:"The calldata to use to call the Foundation contract",name:"data"},{type:"address",description:"The recipient of the ERC721",name:"recipient"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},29:{name:"SWEEP_ERC1155",params:[{type:"address",description:"The ERC1155 token address to sweep",name:"token"},{type:"address",description:"The recipient of the sweep",name:"recipient"},{type:"uint256",description:"The token ID to sweep",name:"id"},{type:"uint256",description:"The minimum required tokens to receive from the sweep",name:"amount"}]}}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/uniswap-commands.ts"}],[263,{"../../../../../shared/constants/network":5465,"./uniswap-commands":262,"@ethersproject/abi":612,"ethereumjs-util":4052},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.UNISWAP_UNIVERSAL_ROUTER_ADDRESSES=void 0,n.decodeUniswapRouterTransactionData=function({transactionData:e,contractAddress:t,chainId:n}){const i=l[n];if(null==i||!i.map(e=>e.toLowerCase()).includes(t.toLowerCase()))return undefined;const d=new s.Interface(u);let p;try{p=d.parseTransaction({data:e})}catch(e){return undefined}const h=p.args.commands,m=p.args.inputs;return h.slice(2).match(/.{1,2}/gu).map((e,t)=>function(e,t){const n=parseInt(e,16),i=31&n,l=r.UNISWAP_ROUTER_COMMANDS[String(i)];if(!l)return undefined;const u=l.params.map(e=>e.type),d=s.Interface.getAbiCoder().decode(u,t),{name:p}=l,h=l.params.map((e,t)=>{const{name:n,type:s,description:i}=e,r=d[t];return{name:n,type:s,value:"path"===n?function(e){const t=[];let n=(0,a.stripHexPrefix)(e),s={},i=!0;for(;n.length;){if(i){const e=(0,a.addHexPrefix)(n.slice(0,o));s.firstAddress?(s.secondAddress=e,t.push(s),s={firstAddress:e}):s.firstAddress=e,n=n.slice(o)}else s.tickSpacing=parseInt(n.slice(0,c),16),n=n.slice(c);i=!i}return t}(r):r,description:i}});return{name:p,params:h}}(e,m[t])).filter(e=>e!==undefined)};var s=e("@ethersproject/abi"),a=e("ethereumjs-util"),i=e("../../../../../shared/constants/network"),r=e("./uniswap-commands");const o=40,c=6,l=n.UNISWAP_UNIVERSAL_ROUTER_ADDRESSES={[i.CHAIN_IDS.ARBITRUM]:["0x4C60051384bd2d3C01bfc845Cf5F4b44bcbE9de5","0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0x5E325eDA8064b456f4781070C0738d849c824258"],[i.CHAIN_IDS.AVALANCHE]:["0x82635AF6146972cD6601161c4472ffe97237D292","0x4Dae2f939ACf50408e13d58534Ff8c2776d45265"],[i.CHAIN_IDS.BASE]:["0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD"],[i.CHAIN_IDS.BSC]:["0x5Dc88340E1c5c6366864Ee415d6034cadd1A9897","0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0x4Dae2f939ACf50408e13d58534Ff8c2776d45265"],[i.CHAIN_IDS.MAINNET]:["0xEf1c6E67703c7BD7107eed8303Fbe6EC2554BF6B","0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD"],[i.CHAIN_IDS.OPTIMISM]:["0xb555edF5dcF85f42cEeF1f3630a52A108E55A654","0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0xCb1355ff08Ab38bBCE60111F1bb2B784bE25D7e8"],[i.CHAIN_IDS.POLYGON]:["0x4C60051384bd2d3C01bfc845Cf5F4b44bcbE9de5","0x643770E279d5D0733F21d6DC03A8efbABf3255B4","0xec7BE89e9d109e7e3Fec59c222CF297125FEFda2"],[i.CHAIN_IDS.SEPOLIA]:["0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD"]},u=[{constant:!0,inputs:[{name:"commands",type:"bytes"},{name:"inputs",type:"bytes[]"},{name:"deadline",type:"uint256"}],name:"execute",type:"function"},{constant:!0,inputs:[{name:"commands",type:"bytes"},{name:"inputs",type:"bytes[]"}],name:"execute",type:"function"}]}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/uniswap.ts"}],[264,{"../../../../../shared/types/transaction-decode":5585,"./four-byte":259,"./proxy":260,"./sourcify":261,"./uniswap":263,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.decodeTransactionData=async function({transactionData:e,contractAddress:t,chainId:n,provider:s}){l("Decoding transaction data",{transactionData:e,contractAddress:t,chainId:n});const d=(0,i.decodeUniswapRouterTransactionData)({transactionData:e,contractAddress:t,chainId:n});if(d)return l("Decoded with Uniswap commands",d),{data:u(d),source:a.DecodedTransactionDataSource.Uniswap};const p=await(0,o.getContractProxyAddress)(t,s);p&&l("Retrieved proxy implementation address",p);const h=p??t,m=(0,r.decodeTransactionDataWithSourcify)(e,h,n),f=(0,c.decodeTransactionDataWithFourByte)(e),[g,y]=await Promise.allSettled([m,f]);if("fulfilled"===g.status&&g.value)return l("Decoded data with Sourcify",g.value),{data:u([g.value]),source:a.DecodedTransactionDataSource.Sourcify};if(l("Failed to decode data with Sourcify",g),"fulfilled"===y.status&&y.value)return l("Decoded data with 4Byte",y.value),{data:u([y.value]),source:a.DecodedTransactionDataSource.FourByte};return l("Failed to decode data with 4Byte",y),undefined};var s=e("@metamask/utils"),a=e("../../../../../shared/types/transaction-decode"),i=e("./uniswap"),r=e("./sourcify"),o=e("./proxy"),c=e("./four-byte");const l=(0,s.createProjectLogger)("transaction-decode");function u(e){return e.map(e=>function(e){return{...e,params:e.params.map(e=>d(e))}}(e))}function d(e){var t;return{...e,value:p(e.value),children:null===(t=e.children)||void 0===t?void 0:t.map(e=>d(e))}}function p(e){const t=e._hex;return t?BigInt(t).toString():e}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/util.ts"}],[265,{"@ethersproject/abi":612,"@metamask/keyring-controller":2022,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.ROOT_AUTHORITY=n.ExecutionMode=n.ANY_BENEFICIARY=void 0,n.encodeRedeemDelegations=function(e,t,n){return new i.Interface(u).encodeFunctionData("redeemDelegations",[p(e),t,(s=n,s.map(h))]);var s},n.signDelegation=async function({chainId:e,delegation:t,from:n,messenger:i}){const c={types:d,primaryType:r,domain:{chainId:String((0,s.hexToNumber)(e)),name:o,version:"1",verifyingContract:"0xdb9B1e94B5b69Df7e401DDbedE43491141047dB3"},message:{...t,chainId:(0,s.hexToNumber)(e)}};return await i.call("KeyringController:signTypedMessage",{from:n,data:c},a.SignTypedDataVersion.V4)};var s=e("@metamask/utils"),a=e("@metamask/keyring-controller"),i=e("@ethersproject/abi");n.ExecutionMode=function(e){return e.BATCH_DEFAULT_MODE="0x0100000000000000000000000000000000000000000000000000000000000000",e}({});n.ROOT_AUTHORITY="0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",n.ANY_BENEFICIARY="0x0000000000000000000000000000000000000a11";const r="Delegation",o="DelegationManager",c=[{type:"address",name:"delegate"},{type:"address",name:"delegator"},{type:"bytes32",name:"authority"},{type:"tuple[]",name:"caveats",components:[{type:"address",name:"enforcer"},{type:"bytes",name:"terms"},{type:"bytes",name:"args"}]},{type:"uint256",name:"salt"},{type:"bytes",name:"signature"}],l=[{type:"address",name:"target"},{type:"uint256",name:"value"},{type:"bytes",name:"callData"}],u=[{type:"function",name:"redeemDelegations",inputs:[{name:"_permissionContexts",type:"bytes[]",internalType:"bytes[]"},{name:"_modes",type:"bytes32[]",internalType:"ModeCode[]"},{name:"_executionCallDatas",type:"bytes[]",internalType:"bytes[]"}],outputs:[],stateMutability:"nonpayable"}],d={EIP712Domain:[{name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}],Caveat:[{name:"enforcer",type:"address"},{name:"terms",type:"bytes"}],Delegation:[{name:"delegate",type:"address"},{name:"delegator",type:"address"},{name:"authority",type:"bytes32"},{name:"caveats",type:"Caveat[]"},{name:"salt",type:"uint256"}]};function p(e){return e.map(e=>{return t=e,i.defaultAbiCoder.encode([i.ParamType.from({components:c,name:"delegations",type:"tuple[]"})],[t]);var t})}function h(e){return i.defaultAbiCoder.encode([i.ParamType.from({components:l,name:"executions",type:"tuple[]"})],[e])}}}},{package:"$root$",file:"app/scripts/lib/transaction/delegation.ts"}],[266,{"../delegation":265,"../transaction-relay":270,"@ethersproject/abi":612,"@metamask/metamask-eth-abis":2077,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.Delegation7702PublishHook=void 0;var s=e("@metamask/utils"),a=e("@metamask/metamask-eth-abis"),i=e("@ethersproject/abi"),r=e("../delegation"),o=e("../transaction-relay");function c(e,t,n){l(e,t),t.set(e,n)}function l(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function u(e,t){return e.get(p(e,t))}function d(e,t,n){return e.set(p(e,t),n),n}function p(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}const h="0x",m={transactionHash:undefined},f=(0,s.createProjectLogger)("delegation-7702-publish-hook");var g=new WeakMap,y=new WeakMap,S=new WeakSet;async function v(e,t){try{return await p(S,this,b).call(this,e,t)}catch(e){throw f("Error",e),e}}async function b(e,t){const{chainId:n,gasFeeTokens:s,selectedGasFeeToken:a,txParams:i}=e,{from:c}=i,l=(await u(g,this).call(this,{address:c,chainIds:[n]})).find(e=>e.chainId.toLowerCase()===n.toLowerCase());if(!(l&&(!l.delegationAddress||l.isSupported)))return f("Skipping as EIP-7702 is not supported",{from:c,chainId:n}),m;const{delegationAddress:d,upgradeContractAddress:h}=l;if(!a||null==s||!s.length)return f("Skipping as no selected gas fee token"),m;const y=s.find(e=>e.tokenAddress.toLowerCase()===a.toLowerCase());if(!y)throw new Error("Selected gas fee token not found");const v=await p(S,this,w).call(this,e,y),b=p(S,this,T).call(this,e,y),_=(0,r.encodeRedeemDelegations)([[v]],[r.ExecutionMode.BATCH_DEFAULT_MODE],[b]),k={chainId:n,data:_,to:"0xdb9B1e94B5b69Df7e401DDbedE43491141047dB3"};d||(k.authorizationList=await p(S,this,E).call(this,e,h)),f("Relay request",k);const{uuid:P}=await(0,o.submitRelayTransaction)(k),{transactionHash:A,status:C}=await(0,o.waitForRelayResult)({chainId:n,uuid:P,interval:1e3});if(C!==o.RelayStatus.Success)throw new Error(`Transaction relay error - ${C}`);return{transactionHash:A}}function T(e,t){const{txParams:n}=e,{data:s,to:a,value:i}=n;return[{target:a,value:i??"0x0",callData:s??h},{target:t.tokenAddress,value:"0x0",callData:p(S,this,k).call(this,t.recipient,t.amount)}]}async function w(e,t){const{chainId:n,txParams:s}=e,{from:a}=s,i=p(S,this,_).call(this,s,t);f("Caveats",i);const o={authority:r.ROOT_AUTHORITY,caveats:i,delegate:r.ANY_BENEFICIARY,delegator:a,salt:(new Date).getTime()};f("Unsigned delegation",o);const c=await(0,r.signDelegation)({chainId:n,delegation:o,from:a,messenger:u(y,this)});return f("Delegation signature",c),{...o,signature:c}}function _(e,t){const{amount:n,recipient:a,tokenAddress:i}=t,{data:r,to:o}=e,c=(0,s.add0x)((0,s.remove0x)(n).padStart(64,"0"));return[{enforcer:"0x00e0251aaA263dfE3B3541B758A82D1CBA1c3B6D",terms:(0,s.add0x)([i,a,c,o,r??h].map(s.remove0x).join("")),args:h}]}async function E(e,t){const{chainId:n,txParams:s}=e,{from:a,nonce:i}=s;if(f("Including authorization as not upgraded"),!t)throw new Error("Upgrade contract address not found");const r=await u(y,this).call("KeyringController:signEip7702Authorization",{chainId:parseInt(n,16),contractAddress:t,from:a,nonce:parseInt(i,16)}),{r:o,s:c,yParity:l}=p(S,this,P).call(this,r);return f("Authorization signature",{authorizationSignature:r,r:o,s:c,yParity:l}),[{address:t,chainId:n,nonce:i,r:o,s:c,yParity:l}]}function k(e,t){return new i.Interface(a.abiERC20).encodeFunctionData("transfer",[e,t])}function P(e){return{r:e.slice(0,66),s:`0x${e.slice(66,130)}`,yParity:parseInt(e.slice(130,132),16)-27==0?"0x":"0x1"}}n.Delegation7702PublishHook=class{constructor({isAtomicBatchSupported:e,messenger:t}){var n,s;l(n=this,s=S),s.add(n),c(this,g,void 0),c(this,y,void 0),d(g,this,e),d(y,this,t)}getHook(){return p(S,this,v).bind(this)}}}}},{package:"$root$",file:"app/scripts/lib/transaction/hooks/delegation-7702-publish.ts"}],[267,{"../containers/util":258,"@metamask/controller-utils":1321,"@metamask/transaction-controller":2790,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.EnforceSimulationHook=void 0;e("@metamask/transaction-controller");var s=e("@metamask/utils");e("@metamask/controller-utils"),e("../containers/util");function a(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(e,t){return e.get(r(e,t))}function r(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}const o=(0,s.createProjectLogger)("enforce-simulation-hook");var c=new WeakMap,l=new WeakSet;async function u(e,t){const{transactionMeta:n}=t,{isFinal:s}=e,{containerTypes:a,delegationAddress:r,id:l,origin:u,simulationData:d,txParamsOriginal:p}=n,h=i(c,this).call("AppStateController:getState");(null==h?void 0:h.enableEnforcedSimulationsForTransactions[l])??(null==h||h.enableEnforcedSimulations);return o("Skipping as enforced simulations are disabled"),{skipSimulation:!1}}n.EnforceSimulationHook=class{constructor({messenger:e}){var t,n;a(t=this,n=l),n.add(t),function(e,t,n){a(e,t),t.set(e,n)}(this,c,void 0),function(e,t,n){e.set(r(e,t),n)}(c,this,e)}getAfterSimulateHook(){return r(l,this,u).bind(this,{})}getBeforeSignHook(){return r(l,this,u).bind(this,{isFinal:!0})}}}}},{package:"$root$",file:"app/scripts/lib/transaction/hooks/enforce-simulation-hook.ts"}],[268,{"../../../../shared/constants/app":5447,"../../../../shared/constants/gas":5455,"../../../../shared/constants/metametrics":5462,"../../../../shared/constants/transaction":5482,"../../../../shared/lib/confirmation.utils":5494,"../../../../shared/lib/transactions-controller-utils":5548,"../../../../shared/modules/Numeric":5553,"../../../../shared/modules/conversion.utils":5558,"../../../../shared/modules/gas.utils":5563,"../../../../shared/modules/metametrics":5566,"../../../../shared/modules/transaction.utils":5581,"../../../../ui/helpers/utils/metrics":6711,"../snap-keyring/metrics":244,"../util":276,"@metamask/transaction-controller":2790,"@metamask/utils":2835,"bignumber.js":3684,"ethereumjs-util":4052},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.handleTransactionSubmitted=n.handleTransactionRejected=n.handleTransactionFailed=n.handleTransactionDropped=n.handleTransactionConfirmed=n.handleTransactionApproved=n.handleTransactionAdded=n.handlePostTransactionBalanceUpdate=n.createTransactionEventFragmentWithTxId=n.METRICS_STATUS_FAILED=void 0;var s=e("bignumber.js"),a=e("ethereumjs-util"),i=e("@metamask/transaction-controller"),r=e("@metamask/utils"),o=e("../../../../shared/constants/app"),c=e("../../../../shared/constants/gas"),l=e("../../../../shared/constants/metametrics"),u=e("../../../../shared/constants/transaction"),d=e("../../../../shared/lib/transactions-controller-utils"),p=e("../../../../shared/modules/conversion.utils"),h=e("../../../../shared/modules/metametrics"),m=e("../../../../shared/modules/transaction.utils"),f=e("../../../../ui/helpers/utils/metrics"),g=e("../snap-keyring/metrics"),y=e("../../../../shared/lib/confirmation.utils"),S=e("../../../../shared/modules/gas.utils"),v=e("../../../../shared/modules/Numeric"),b=e("../util");const T=(0,r.createProjectLogger)("transaction-metrics"),w=n.METRICS_STATUS_FAILED="failed on-chain",_=[i.TransactionType.bridge,i.TransactionType.bridgeApproval,i.TransactionType.contractInteraction,i.TransactionType.tokenMethodApprove,i.TransactionType.tokenMethodIncreaseAllowance,i.TransactionType.tokenMethodSafeTransferFrom,i.TransactionType.tokenMethodSetApprovalForAll,i.TransactionType.tokenMethodTransfer,i.TransactionType.tokenMethodTransferFrom,i.TransactionType.swap,i.TransactionType.swapAndSend,i.TransactionType.swapApproval];var E=function(e){return e.swap="mm_swap",e.bridge="mm_bridge",e}(E||{});n.handleTransactionAdded=async(e,t)=>{if(!t.transactionMeta)return;const{properties:n,sensitiveProperties:s}=await C({transactionEventPayload:t,transactionMetricsRequest:e});k({eventName:u.TransactionMetaMetricsEvent.added,transactionEventPayload:t,transactionMetricsRequest:e,payload:{properties:n,sensitiveProperties:s}})};n.handleTransactionApproved=async(e,t)=>{t.transactionMeta&&await P({eventName:u.TransactionMetaMetricsEvent.approved,transactionEventPayload:t,transactionMetricsRequest:e})};n.handleTransactionFailed=async(e,t)=>{if(!t.transactionMeta)return;const n={};t.error&&(n.error=t.error),await P({eventName:u.TransactionMetaMetricsEvent.finalized,extraParams:n,transactionEventPayload:t,transactionMetricsRequest:e})};n.handleTransactionConfirmed=async(e,t)=>{if(0===Object.keys(t).length)return;const n={},s={...t},{txReceipt:a}=s;n.gas_used=null==a?void 0:a.gasUsed,n.block_number=(null==a?void 0:a.blockNumber)&&(0,p.hexToDecimal)(a.blockNumber);const{submittedTime:i,blockTimestamp:r}=s;i&&(n.completion_time=function(e){return Math.round((Date.now()-e)/1e3).toString()}(i)),i&&r&&(n.completion_time_onchain=function(e,t){const n=2,s=Number((0,p.hexToDecimal)(t))-e/1e3;return(Math.round(s*10**n)/10**n).toString()}(i,r)),"0x0"===(null==a?void 0:a.status)&&(n.status=w),await P({eventName:u.TransactionMetaMetricsEvent.finalized,extraParams:n,transactionEventPayload:{actionId:s.actionId,transactionMeta:s},transactionMetricsRequest:e})};n.handleTransactionDropped=async(e,t)=>{if(!t.transactionMeta)return;await P({eventName:u.TransactionMetaMetricsEvent.finalized,extraParams:{dropped:!0},transactionEventPayload:t,transactionMetricsRequest:e})};n.handleTransactionRejected=async(e,t)=>{t.transactionMeta&&await P({eventName:u.TransactionMetaMetricsEvent.rejected,transactionEventPayload:t,transactionMetricsRequest:e})};n.handleTransactionSubmitted=async(e,t)=>{if(!t.transactionMeta)return;const{properties:n,sensitiveProperties:s}=await C({transactionEventPayload:t,transactionMetricsRequest:e});k({eventName:u.TransactionMetaMetricsEvent.submitted,transactionEventPayload:t,transactionMetricsRequest:e,payload:{properties:n,sensitiveProperties:s}})};n.createTransactionEventFragmentWithTxId=async(e,{transactionId:t,actionId:n})=>{const s={...e.getTransaction(t),actionId:n},{properties:a,sensitiveProperties:i}=await C({transactionEventPayload:{transactionMeta:s},transactionMetricsRequest:e});k({eventName:u.TransactionMetaMetricsEvent.approved,transactionEventPayload:{actionId:s.actionId,transactionMeta:s},transactionMetricsRequest:e,payload:{properties:a,sensitiveProperties:i}})};function k({eventName:e,transactionEventPayload:{transactionMeta:t,actionId:n},transactionMetricsRequest:s,payload:a}){if(function(e,t,n){const s=A(t,n.id);return void 0!==e(s)}(s.getEventFragmentById,e,t)&&e!==u.TransactionMetaMetricsEvent.submitted)return;const i=A(e,t.id);switch(e){case u.TransactionMetaMetricsEvent.added:s.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,initialEvent:u.TransactionMetaMetricsEvent.added,successEvent:u.TransactionMetaMetricsEvent.approved,failureEvent:u.TransactionMetaMetricsEvent.rejected,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:n,uniqueIdentifier:i,persist:!0});break;case u.TransactionMetaMetricsEvent.approved:case u.TransactionMetaMetricsEvent.rejected:s.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,successEvent:u.TransactionMetaMetricsEvent.approved,failureEvent:u.TransactionMetaMetricsEvent.rejected,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:n,uniqueIdentifier:i,persist:!0});break;case u.TransactionMetaMetricsEvent.submitted:s.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,initialEvent:u.TransactionMetaMetricsEvent.submitted,successEvent:u.TransactionMetaMetricsEvent.finalized,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:n,uniqueIdentifier:i,persist:!0});break;case u.TransactionMetaMetricsEvent.finalized:s.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,successEvent:u.TransactionMetaMetricsEvent.finalized,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:n,uniqueIdentifier:i,persist:!0})}}async function P({eventName:e,transactionEventPayload:t,transactionMetricsRequest:n,extraParams:s={}}){const{properties:a,sensitiveProperties:i}=await C({transactionEventPayload:t,transactionMetricsRequest:n,extraParams:s});k({eventName:e,transactionEventPayload:t,transactionMetricsRequest:n,payload:{properties:a,sensitiveProperties:i}}),function({eventName:e,transactionEventPayload:{transactionMeta:t},transactionMetricsRequest:n,payload:s}){const a=A(e,t.id);switch(e){case u.TransactionMetaMetricsEvent.approved:case u.TransactionMetaMetricsEvent.rejected:case u.TransactionMetaMetricsEvent.finalized:n.updateEventFragment(a,{properties:s.properties,sensitiveProperties:s.sensitiveProperties})}}({eventName:e,transactionEventPayload:t,transactionMetricsRequest:n,payload:{properties:a,sensitiveProperties:i}}),function({eventName:e,transactionMetricsRequest:t,transactionEventPayload:{transactionMeta:n}}){const s=A(e,n.id);switch(e){case u.TransactionMetaMetricsEvent.approved:case u.TransactionMetaMetricsEvent.finalized:t.finalizeEventFragment(s);break;case u.TransactionMetaMetricsEvent.rejected:t.finalizeEventFragment(s,{abandoned:!0})}}({eventName:e,transactionEventPayload:t,transactionMetricsRequest:n})}function A(e,t){return`transaction-${e===u.TransactionMetaMetricsEvent.finalized||e===u.TransactionMetaMetricsEvent.submitted?"submitted":"added"}-${t}`}async function C({transactionEventPayload:{transactionMeta:e},transactionMetricsRequest:t,extraParams:n={}}){var w;const{type:E,time:k,status:P,chainId:A,origin:C,txParams:{gasPrice:M,gas:R,maxFeePerGas:O,maxPriorityFeePerGas:N,estimateSuggested:x,estimateUsed:D},defaultGasEstimates:j,originalType:L,replacedById:F,customTokenAmount:H,dappProposedTokenAmount:$,currentTokenBalance:B,originalApprovalAmount:U,finalApprovalAmount:V,securityProviderResponse:q,simulationFails:W,id:G,userFeeLevel:z}=e,Y=C===o.ORIGIN_METAMASK?"user":"dapp",K="dappSuggested"===z?"dapp_proposed":z,{assetType:J,tokenStandard:X}=await(0,m.determineTransactionAssetType)(e,t.provider,t.getTokenStandardAndDetails);let Z;if(e.txParams.data){const n=await t.getMethodData(e.txParams.data);Z=null==n?void 0:n.name}const Q={};if((0,m.isEIP1559Transaction)(e)?(Q.max_fee_per_gas=O,Q.max_priority_fee_per_gas=N):(Q.gas_price=M,Q.default_estimate=l.MetaMetricsEventTransactionEstimateType.DefaultEstimate),j){var ee,te;const{estimateType:n}=j;if(n){var ne,se;Q.default_estimate=n===c.PriorityLevels.dAppSuggested?l.MetaMetricsEventTransactionEstimateType.DappProposed:n;let s=null===(ne=e.defaultGasEstimates)||void 0===ne?void 0:ne.maxFeePerGas,a=null===(se=e.defaultGasEstimates)||void 0===se?void 0:se.maxPriorityFeePerGas;if([c.GasRecommendations.low,c.GasRecommendations.medium,c.GasRecommendations.high].includes(n)){var ae,ie;const{gasFeeEstimates:e}=await t.getEIP1559GasFeeEstimates();var re,oe;if(null!=e&&null!==(ae=e[n])&&void 0!==ae&&ae.suggestedMaxFeePerGas)s=null===(re=e[n])||void 0===re?void 0:re.suggestedMaxFeePerGas,Q.default_max_fee_per_gas=s;if(null!=e&&null!==(ie=e[n])&&void 0!==ie&&ie.suggestedMaxPriorityFeePerGas)a=null===(oe=e[n])||void 0===oe?void 0:oe.suggestedMaxPriorityFeePerGas,Q.default_max_priority_fee_per_gas=a}}null!==(ee=e.defaultGasEstimates)&&void 0!==ee&&ee.gas&&(Q.default_gas=e.defaultGasEstimates.gas),null!==(te=e.defaultGasEstimates)&&void 0!==te&&te.gasPrice&&(Q.default_gas_price=e.defaultGasEstimates.gasPrice)}x&&(Q.estimate_suggested=x),D&&(Q.estimate_used=D),null!=n&&n.gas_used&&(Q.gas_used=n.gas_used);const ce=function(e){const t={};for(const n in e)(0,a.isHexString)(e[n])?t[n]=(0,p.hexWEIToDecGWEI)(e[n]):t[n]=e[n];return t}(Q);let le="0";e.txParams.maxFeePerGas&&(le="2");const ue="Approve";let de,pe,he,me,fe,ge;const{transactionType:ye,isContractInteraction:Se}=function(e,t){const n=e&&_.includes(e);if([i.TransactionType.swapAndSend,i.TransactionType.cancel,i.TransactionType.deployContract,i.TransactionType.gasPayment,i.TransactionType.batch].includes(e))return{transactionType:e,isContractInteraction:n};if(e===i.TransactionType.retry&&t)return{transactionType:t,isContractInteraction:n};if(n){const t=I(e);return t?{transactionType:t,isContractInteraction:!0}:{transactionType:i.TransactionType.contractInteraction,isContractInteraction:!0}}return{transactionType:i.TransactionType.simpleSend,isContractInteraction:!1}}(E,L);var ve,be;Se&&(pe=Z,fe=null===(ve=e.txParams)||void 0===ve?void 0:ve.to,ge=null===(be=e.txParams)||void 0===be||null===(be=be.data)||void 0===be?void 0:be.slice(0,10),pe===ue&&X===u.TokenStandard.ERC20&&("0"===$||"0"===H?de=u.TransactionApprovalAmountType.revoke:H&&H!==$?de=u.TransactionApprovalAmountType.custom:$&&(de=u.TransactionApprovalAmountType.dappProposed),he=function(e,t,n){if(e===u.TransactionApprovalAmountType.custom&&t&&n)return`${new s.BigNumber(t,10).div(n,10).times(100).round(2)}`;return null}(de,U,V),me=function(e,t,n){if((e===u.TransactionApprovalAmountType.custom||e===u.TransactionApprovalAmountType.dappProposed)&&t&&n)return`${new s.BigNumber(t,16).div(n,10).times(100).round(2)}`;return null}(de,$,B)));const Te=t.getTransaction(F),we={RETRY:i.TransactionType.retry,CANCEL:i.TransactionType.cancel,SAME_NONCE:"other"};let _e;null!=n&&n.dropped&&(_e=we.SAME_NONCE,(null==Te?void 0:Te.type)===i.TransactionType.cancel?_e=we.CANCEL:(null==Te?void 0:Te.type)===i.TransactionType.retry&&(_e=we.RETRY));const Ee=[];let ke=null;1===(null==q?void 0:q.flagAsDangerous)?Ee.push(l.MetaMetricsEventUiCustomization.FlaggedAsMalicious):2===(null==q?void 0:q.flagAsDangerous)&&Ee.push(l.MetaMetricsEventUiCustomization.FlaggedAsSafetyUnknown);const Pe=(0,f.getBlockaidMetricsProps)(e);(null==Pe||null===(w=Pe.ui_customizations)||void 0===w?void 0:w.length)>0&&Ee.push(...Pe.ui_customizations),W&&Ee.push(l.MetaMetricsEventUiCustomization.GasEstimationFailed);(0,y.shouldUseRedesignForTransactions)({transactionMetadataType:e.type})&&(Ee.push(l.MetaMetricsEventUiCustomization.RedesignedConfirmation),ke=t.getIsConfirmationAdvancedDetailsOpen());const Ae=(0,h.getSmartTransactionMetricsProperties)(t,e),Ce=(0,f.getSwapAndSendMetricsProps)(e),Ie={hd_entropy_index:t.getHDEntropyIndex()};let Me;try{Me=await t.getAccountType(t.getSelectedAddress())}catch(e){Me="error",T("Error getting account type for transaction metrics:",e)}let Re={chain_id:A,referrer:C,source:Y,status:P,network:`${parseInt(A,16)}`,eip_1559_version:le,gas_edit_type:"none",gas_edit_attempted:"none",gas_estimation_failed:Boolean(W),account_type:Me,device_model:await t.getDeviceModel(t.getSelectedAddress()),asset_type:J,token_standard:X,transaction_type:ye,transaction_speed_up:E===i.TransactionType.retry,transaction_internal_id:G,gas_fee_selected:K,...Pe,ui_customizations:Ee.length>0?Ee:null,transaction_advanced_view:ke,transaction_contract_method:pe?[pe]:[],...Ae,...Ce,...Ie};const Oe=await(0,g.getSnapAndHardwareInfoForMetrics)(t.getAccountType,t.getDeviceModel,t.getHardwareTypeForMetric,t.snapAndHardwareMessenger);var Ne,xe;(Object.assign(Re,Oe),pe===ue||I(E))&&(Re={...Re,simulation_receiving_assets_total_value:Re.simulation_receiving_assets_total_value??(null==e||null===(Ne=e.assetsFiatValues)||void 0===Ne?void 0:Ne.receiving),simulation_sending_assets_total_value:Re.simulation_sending_assets_total_value??(null==e||null===(xe=e.assetsFiatValues)||void 0===xe?void 0:xe.sending),transaction_approval_amount_type:de});let De={transaction_envelope_type:(0,m.isEIP1559Transaction)(e)?d.TRANSACTION_ENVELOPE_TYPE_NAMES.FEE_MARKET:d.TRANSACTION_ENVELOPE_TYPE_NAMES.LEGACY,first_seen:k,gas_limit:R,transaction_replaced:_e,transaction_contract_address:fe?[fe]:[],transaction_contract_method_4byte:ge,...n,...ce};if(pe===ue&&(De={...De,transaction_approval_amount_vs_balance_ratio:me,transaction_approval_amount_vs_proposed_ratio:he}),await async function(e,t,n,s){const a=origin&&origin!==o.ORIGIN_METAMASK,{delegationAddress:r,nestedTransactions:c,txParams:l}=e,{authorizationList:d}=l,p=Boolean(null==c?void 0:c.length),h=Boolean(null==d?void 0:d.length);a&&(n.api_method=p?o.MESSAGE_TYPE.WALLET_SEND_CALLS:o.MESSAGE_TYPE.ETH_SEND_TRANSACTION);p&&(n.batch_transaction_count=null==c?void 0:c.length,n.batch_transaction_method="eip7702",n.transaction_contract_method=await async function(e,t){const n=e.filter(e=>_.includes(e.type)&&e.data).map(e=>e.data),s=await Promise.all(n.map(e=>t(e)));return s.map(e=>null==e?void 0:e.name).filter(e=>null==e?void 0:e.length)}(c??[],t),s.transaction_contract_address=null==c?void 0:c.filter(e=>{var t;return _.includes(e.type)&&(null===(t=e.to)||void 0===t?void 0:t.length)}).map(e=>e.to));if(e.status===i.TransactionStatus.rejected){const{error:t}=e;n.eip7702_upgrade_rejection=h&&t.code===u.EIP5792ErrorCode.RejectedUpgrade}n.eip7702_upgrade_transaction=h,s.account_eip7702_upgraded=r}(e,t.getMethodData,Re,De),function(e,t,n,s){var a;const{gasFeeTokens:i,selectedGasFeeToken:o}=e;t.gas_payment_tokens_available=null==i?void 0:i.map(e=>e.symbol),t.gas_paid_with=null==i||null===(a=i.find(e=>e.tokenAddress.toLowerCase()===(null==o?void 0:o.toLowerCase())))||void 0===a?void 0:a.symbol,(null==o?void 0:o.toLowerCase())===u.NATIVE_TOKEN_ADDRESS&&(t.gas_paid_with="pre-funded_ETH");t.gas_insufficient_native_asset=function(e,t){const{chainId:n,txParams:s}=e,{from:a,gas:i,gasPrice:o,maxFeePerGas:c,value:l}=s,u=t(a,n),d=(0,S.getMaximumGasTotalInHexWei)({gasLimit:i,gasPrice:o,maxFeePerGas:c}),h=(0,r.add0x)((0,p.addHexes)(d,l??"0x0"));return new v.Numeric(h,16).greaterThan(new v.Numeric(u,16))}(e,s)}(e,Re,0,t.getAccountBalance),P===i.TransactionStatus.submitted||P===i.TransactionStatus.confirmed){const n=t.getNetworkRpcUrl(e.chainId),s=(0,b.extractRpcDomain)(n);Re.rpc_domain=s}return{properties:Re,sensitiveProperties:De}}function I(e){return e===i.TransactionType.swap?E.swap:e===i.TransactionType.bridge?E.bridge:null}n.handlePostTransactionBalanceUpdate=async({getParticipateInMetrics:e,trackEvent:t,getHDEntropyIndex:n},{transactionMeta:a,approvalTransactionMeta:i})=>{var r;if(e()&&a.swapMetaData)if("0x0"===(null===(r=a.txReceipt)||void 0===r?void 0:r.status))t({event:l.MetaMetricsEventName.SwapFailed,category:l.MetaMetricsEventCategory.Swaps,sensitiveProperties:{...a.swapMetaData},properties:{hd_entropy_index:n()}});else{var o;const e=(0,d.getSwapsTokensReceivedFromTxMeta)(a.destinationTokenSymbol,a,a.destinationTokenAddress,a.txParams.from,a.destinationTokenDecimals,i,a.chainId),r=e?`${new s.BigNumber(e,10).div(a.swapMetaData.token_to_amount,10).times(100).round(2)}%`:null,c=null!==(o=a.txReceipt)&&void 0!==o&&o.gasUsed&&a.swapMetaData.estimated_gas?`${new s.BigNumber(a.txReceipt.gasUsed,16).div(a.swapMetaData.estimated_gas,10).times(100).round(2)}%`:null,u=function(e,t){var n,a;let i="0x0";null!=t&&t.txReceipt&&(i=(0,d.calcGasTotal)(t.txReceipt.gasUsed,t.txReceipt.effectiveGasPrice));const r=(0,d.calcGasTotal)(null===(n=e.txReceipt)||void 0===n?void 0:n.gasUsed,null===(a=e.txReceipt)||void 0===a?void 0:a.effectiveGasPrice),o=new s.BigNumber(r,16).plus(i,16).toString(16);return{approvalGasCostInEth:Number((0,p.hexWEIToDecETH)(i)),tradeGasCostInEth:Number((0,p.hexWEIToDecETH)(r)),tradeAndApprovalGasCostInEth:Number((0,p.hexWEIToDecETH)(o))}}(a,i);t({event:l.MetaMetricsEventName.SwapCompleted,category:l.MetaMetricsEventCategory.Swaps,sensitiveProperties:{...a.swapMetaData,token_to_amount_received:e,quote_vs_executionRatio:r,estimated_vs_used_gasRatio:c,approval_gas_cost_in_eth:u.approvalGasCostInEth,trade_gas_cost_in_eth:u.tradeGasCostInEth,trade_and_approval_gas_cost_in_eth:u.tradeAndApprovalGasCostInEth,token_to_amount:a.swapMetaData.token_to_amount.toString(10)},properties:{hd_entropy_index:n()}})}}}}},{package:"$root$",file:"app/scripts/lib/transaction/metrics.ts"}],[269,{"../../../../shared/modules/conversion.utils":5558,"../../../../shared/modules/fetch-with-timeout":5562},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.buildUrl=u,n.getSendBundleSupportedChains=async function(e){const t=await c();return e.reduce((e,n)=>{const s=(0,a.hexToDecimal)(n),i=t[s];return e[n]=(null==i?void 0:i.sendBundle)??!1,e},{})},n.getSentinelNetworkFlags=l,n.isSendBundleSupported=async function(e){const t=await l(e);if(null==t||!t.sendBundle)return!1;return!0};var s,a=e("../../../../shared/modules/conversion.utils"),i=(s=e("../../../../shared/modules/fetch-with-timeout"))&&s.__esModule?s:{default:s};const r="https://tx-sentinel-{0}.api.cx.metamask.io/",o="networks";async function c(){const e=`${u("ethereum-mainnet")}${o}`;return(await(0,i.default)()(e)).json()}async function l(e){const t=(0,a.hexToDecimal)(e);return(await c())[t]}function u(e){return r.replace("{0}",e)}}}},{package:"$root$",file:"app/scripts/lib/transaction/sentinel-api.ts"}],[27,{"@metamask/assets-controllers":1138},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.DeFiPositionsControllerInit=void 0;var s=e("@metamask/assets-controllers");n.DeFiPositionsControllerInit=({initMessenger:e,controllerMessenger:t,getController:n})=>({controller:new s.DeFiPositionsController({messenger:t,isEnabled:()=>{var t;const s=n("PreferencesController"),{useExternalServices:a}=s.state,i=e.call("RemoteFeatureFlagController:getState"),r=Boolean(null==i||null===(t=i.remoteFeatureFlags)||void 0===t?void 0:t.assetsDefiPositionsEnabled);return a&&r},trackEvent:e.call.bind(e,"MetaMetricsController:trackEvent")})})}}},{package:"$root$",file:"app/scripts/controller-init/defi-positions/defi-positions-controller-init.ts"}],[270,{"../../../../shared/modules/fetch-with-timeout":5562,"../../../../shared/modules/rpc.utils":5571,"./sentinel-api":269,"@metamask/utils":2835},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.RelayStatus=n.RELAY_RPC_METHOD=void 0,n.isRelaySupported=async function(e){return Boolean(await d(e))},n.submitRelayTransaction=async function(e){const{chainId:t}=e,n=await d(t);if(!n)throw new Error(`Chain not supported by transaction relay - ${t}`);c("Request",n,e);const s=await(0,i.jsonRpcRequest)(n,u,[e]);return c("Response",s),s},n.waitForRelayResult=async function(e){const{chainId:t,interval:n,uuid:s}=e,a=await d(t);if(!a)throw new Error(`Chain not supported by transaction relay - ${t}`);const i=`${a}smart-transactions/${s}`;return new Promise((e,t)=>{const s=setInterval(async()=>{try{const t=await async function(e){c("Polling request",e);const t=await(0,r.default)()(e);if(c("Polling response",t),!t.ok){const e=await t.text();throw new Error(`Failed to fetch relay transaction status: ${t.status} - ${e}`)}const n=await t.json(),s=null==n?void 0:n.transactions[0],{hash:a,status:i}=s||{};return{status:i,transactionHash:a}}(i);t.status!==l.Pending&&(clearInterval(s),e(t))}catch(e){clearInterval(s),t(e)}},n)})};var s,a=e("@metamask/utils"),i=e("../../../../shared/modules/rpc.utils"),r=(s=e("../../../../shared/modules/fetch-with-timeout"))&&s.__esModule?s:{default:s},o=e("./sentinel-api");const c=(0,a.createProjectLogger)("transaction-relay");let l=n.RelayStatus=function(e){return e.Pending="PENDING",e.Success="VALIDATED",e}({});const u=n.RELAY_RPC_METHOD="eth_sendRelayTransaction";async function d(e){const t=await(0,o.getSentinelNetworkFlags)(e);return null!=t&&t.relayTransactions?(0,o.buildUrl)(t.network):(c("Chain is not supported",e),undefined)}}}},{package:"$root$",file:"app/scripts/lib/transaction/transaction-relay.ts"}],[271,{"../../../../shared/constants/app":5447,"../../../../shared/constants/security-provider":5472,"../../../../shared/lib/trace":5546,"../ppom/ppom-util":216,"../trust-signals/security-alerts-api":272,"../trust-signals/trust-signals-util":274,"@metamask/keyring-api":2012,"ethereumjs-util":4052},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.addDappTransaction=async function(e){const{dappRequest:t}=e,{id:n,method:s,origin:a}=t,{securityAlertResponse:i,traceContext:r}=t,c={actionId:n,method:s,origin:a,requireApproval:!0,securityAlertResponse:i};(0,o.endTrace)({name:o.TraceName.Middleware,id:n});const{waitForHash:l}=await d({...e,transactionOptions:{...c,traceContext:r}}),u=await l();return(0,o.endTrace)({name:o.TraceName.Transaction,id:n}),u},n.addTransaction=async function(e){await async function(e){const{chainId:t,ppomController:n,securityAlertsEnabled:s,transactionOptions:a,transactionParams:o,updateSecurityAlertResponse:d,internalAccounts:p,getSecurityAlertsConfig:h}=e;!function(e){const{getSecurityAlertResponse:t,addSecurityAlertResponse:n,securityAlertsEnabled:s,transactionOptions:a,transactionParams:i,chainId:r}=e,{origin:o}=a;if(o!==c.ORIGIN_METAMASK||!s)return;const{to:d}=i;if("string"!=typeof d)return;const p=(0,u.mapChainIdToSupportedEVMChain)(r);if(!p)return;(0,l.scanAddressAndAddToCache)(d,t,n,p).catch(e=>{console.error("[scanAddressForTrustSignals] error scanning address for trust signals:",e)})}(e);const{type:m}=a,f=r.SECURITY_PROVIDER_EXCLUDED_TRANSACTION_TYPES.includes(m);if(!s||f)return;if(p.some(({address:e})=>{var t;return e.toLowerCase()===(null===(t=o.to)||void 0===t?void 0:t.toLowerCase())}))return;try{const{from:s,to:c,value:l,data:u}=o,{actionId:p,origin:m}=a,f={method:"eth_sendTransaction",id:p??"",origin:m??"",params:[{from:s,to:c??"",value:l??"",data:u??""}],jsonrpc:"2.0"},g=(0,i.generateSecurityAlertId)();(0,i.validateRequestWithPPOM)({ppomController:n,request:f,securityAlertId:g,chainId:t,updateSecurityAlertResponse:d,getSecurityAlertsConfig:h});const y={...r.LOADING_SECURITY_ALERT_RESPONSE,securityAlertId:g};e.transactionOptions.securityAlertResponse=y}catch(e){(0,i.handlePPOMError)(e,"Error validating JSON RPC using PPOM: ")}}(e);const{transactionMeta:t,waitForHash:n}=await d(e);if(!e.waitForSubmit)return n().catch(()=>{}),t;const s=await n();return function(e,t){return t.state.transactions.find(t=>t.hash===e)}(s,e.transactionController)},n.getTransactionById=p;var s=e("@metamask/keyring-api"),a=e("ethereumjs-util"),i=e("../ppom/ppom-util"),r=e("../../../../shared/constants/security-provider"),o=e("../../../../shared/lib/trace"),c=e("../../../../shared/constants/app"),l=e("../trust-signals/security-alerts-api"),u=e("../trust-signals/trust-signals-util");async function d(e){const{selectedAccount:t}=e;return t.type===s.EthAccountType.Erc4337?async function(e){var t;const{networkClientId:n,transactionController:s,transactionOptions:i,transactionParams:r,userOperationController:o}=e,{maxFeePerGas:c,maxPriorityFeePerGas:l}=r,{origin:u,requireApproval:d,type:h}=i,m={...r,maxFeePerGas:(0,a.addHexPrefix)(c),maxPriorityFeePerGas:(0,a.addHexPrefix)(l)},f=null==i||null===(t=i.swaps)||void 0===t?void 0:t.meta;null!=f&&f.type&&delete f.type;const g={networkClientId:n,origin:u,requireApproval:d,swaps:f,type:h},y=await o.addUserOperationFromTransaction(m,g);o.startPollingByNetworkClientId(n);return{transactionMeta:p(y.id,s),waitForHash:y.transactionHash}}(e):async function(e){const{transactionController:t,transactionOptions:n,transactionParams:s,networkClientId:a}=e,{result:i,transactionMeta:r}=await t.addTransaction(s,{...n,networkClientId:a});return{transactionMeta:r,waitForHash:()=>i}}(e)}function p(e,t){return t.state.transactions.find(t=>t.id===e)}}}},{package:"$root$",file:"app/scripts/lib/transaction/util.ts"}],[272,{"../../../../shared/constants/time":5480,"../../../../shared/modules/fetch-with-timeout":5562,"./types":275},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.scanAddress=l,n.scanAddressAndAddToCache=async function(e,t,n,s){const a=t(e);if(a)return a;const i={result_type:r.ResultType.Loading,label:""};n(e,i);try{const t=await l(s,e);return n(e,t),t}catch(t){throw n(e,{result_type:r.ResultType.ErrorResult,label:""}),t}};var s,a=e("../../../../shared/constants/time"),i=(s=e("../../../../shared/modules/fetch-with-timeout"))&&s.__esModule?s:{default:s},r=e("./types");const o=5*a.SECOND,c="address/evm/scan";async function l(e,t){const n="https://security-alerts.api.cx.metamask.io";const s=`${n}/${c}`,a={chain:e,address:t},r=await(0,i.default)(o)(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return await r.json()}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/security-alerts-api.ts"}],[273,{"../../../../shared/modules/transaction.utils":5581,"../ppom/security-alerts-api":218,"./security-alerts-api":272,"./trust-signals-util":274},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.createTrustSignalsMiddleware=function(e,t,n,c,l){return async(u,d,p)=>{try{if(!(0,r.isSecurityAlertsEnabledByUser)(c)||!(0,a.isSecurityAlertsAPIEnabled)())return;(0,r.isEthSendTransaction)(u)?(!function(e,t,n){if(!(0,r.hasValidTransactionParams)(e))return;const{to:s}=e.params[0];let a;try{a=(0,r.getChainId)(n)}catch(e){return void console.error("[createTrustSignalsMiddleware] error getting chainId:",e)}if(!a)return;(0,i.scanAddressAndAddToCache)(s,t.getAddressSecurityAlertResponse,t.addAddressSecurityAlertResponse,a).catch(e=>{console.error("[createTrustSignalsMiddleware] error scanning address for transaction:",e)})}(u,t,e),o(u,n)):(0,r.isEthSignTypedData)(u)?(!function(e,t,n){var a;if(!(0,r.hasValidTypedDataParams)(e))return;const o=(0,s.parseTypedDataMessage)("string"==typeof e.params[1]?e.params[1]:JSON.stringify(e.params[1])),c=null===(a=o.domain)||void 0===a?void 0:a.verifyingContract;if(!c)return;let l;try{l=(0,r.getChainId)(n)}catch(e){return void console.error("[createTrustSignalsMiddleware] error getting chainId:",e)}if(!l)return;(0,i.scanAddressAndAddToCache)(c,t.getAddressSecurityAlertResponse,t.addAddressSecurityAlertResponse,l).catch(e=>{console.error("[createTrustSignalsMiddleware] error scanning address for signature:",e)})}(u,t,e),o(u,n)):((0,r.isConnected)(u,l)||(0,r.connectScreenHasBeenPrompted)(u))&&o(u,n)}catch(e){console.error("[createTrustSignalsMiddleware] error: ",e)}finally{p()}}};var s=e("../../../../shared/modules/transaction.utils"),a=e("../ppom/security-alerts-api"),i=e("./security-alerts-api"),r=e("./trust-signals-util");function o(e,t){e.origin&&t.scanUrl(e.origin).catch(e=>{console.error("[createTrustSignalsMiddleware] error:",e)})}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/trust-signals-middleware.ts"}],[274,{"../../../../shared/constants/app":5447,"../../../../shared/constants/network":5465,"../../../../shared/modules/selectors/networks":5575,"./types":275},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.connectScreenHasBeenPrompted=function(e){return e.method===i.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS||e.method===i.MESSAGE_TYPE.WALLET_REQUEST_PERMISSIONS},n.getChainId=function(e){var t;const n=null===(t=(0,a.getProviderConfig)({metamask:e.state}))||void 0===t?void 0:t.chainId;if(!n)throw new Error("Chain ID not found");return c(n)},n.hasValidTransactionParams=function(e){if(!("params"in e)||!e.params)return!1;if(!Array.isArray(e.params)||0===e.params.length)return!1;const t=e.params[0];return"object"==typeof t&&null!==t&&"to"in t},n.hasValidTypedDataParams=function(e){if(!("params"in e)||!e.params)return!1;if(!Array.isArray(e.params)||e.params.length<2)return!1;return e.params[1]!==undefined&&null!==e.params[1]},n.isConnected=function(e,t){if(!e.origin||e.method!==i.MESSAGE_TYPE.ETH_ACCOUNTS)return!1;const n=t(e.origin);return Array.isArray(n)&&n.length>0},n.isEthSendTransaction=function(e){return e.method===i.MESSAGE_TYPE.ETH_SEND_TRANSACTION},n.isEthSignTypedData=function(e){return e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA||e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V1||e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V3||e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V4},n.isSecurityAlertsEnabledByUser=function(e){const{securityAlertsEnabled:t}=e.state;return t},n.mapChainIdToSupportedEVMChain=c;var s=e("../../../../shared/constants/network"),a=e("../../../../shared/modules/selectors/networks"),i=e("../../../../shared/constants/app"),r=e("./types");const o={[s.CHAIN_IDS.ARBITRUM.toLowerCase()]:r.SupportedEVMChain.Arbitrum,[s.CHAIN_IDS.AVALANCHE.toLowerCase()]:r.SupportedEVMChain.Avalanche,[s.CHAIN_IDS.BASE.toLowerCase()]:r.SupportedEVMChain.Base,[s.CHAIN_IDS.BASE_SEPOLIA.toLowerCase()]:r.SupportedEVMChain.BaseSepolia,[s.CHAIN_IDS.BSC.toLowerCase()]:r.SupportedEVMChain.Bsc,[s.CHAIN_IDS.MAINNET.toLowerCase()]:r.SupportedEVMChain.Ethereum,[s.CHAIN_IDS.OPTIMISM.toLowerCase()]:r.SupportedEVMChain.Optimism,[s.CHAIN_IDS.POLYGON.toLowerCase()]:r.SupportedEVMChain.Polygon,[s.CHAIN_IDS.ZKSYNC_ERA.toLowerCase()]:r.SupportedEVMChain.Zksync,[s.CHAIN_IDS.ZK_SYNC_ERA_TESTNET.toLowerCase()]:r.SupportedEVMChain.ZksyncSepolia,"0x76adf1":r.SupportedEVMChain.Zora,[s.CHAIN_IDS.LINEA_MAINNET.toLowerCase()]:r.SupportedEVMChain.Linea,[s.CHAIN_IDS.BLAST.toLowerCase()]:r.SupportedEVMChain.Blast,[s.CHAIN_IDS.SCROLL.toLowerCase()]:r.SupportedEVMChain.Scroll,[s.CHAIN_IDS.SEPOLIA.toLowerCase()]:r.SupportedEVMChain.EthereumSepolia,"0x27bc86aa":r.SupportedEVMChain.Degen,[s.CHAIN_IDS.AVALANCHE_TESTNET.toLowerCase()]:r.SupportedEVMChain.AvalancheFuji,"0x343b":r.SupportedEVMChain.ImmutableZkevm,"0x34a1":r.SupportedEVMChain.ImmutableZkevmTestnet,[s.CHAIN_IDS.GNOSIS.toLowerCase()]:r.SupportedEVMChain.Gnosis,"0x1e0":r.SupportedEVMChain.Worldchain,"0x79a":r.SupportedEVMChain.SoneiumMinato,"0x7e4":r.SupportedEVMChain.Ronin,[s.CHAIN_IDS.APECHAIN_MAINNET.toLowerCase()]:r.SupportedEVMChain.ApeChain,"0x849ea":r.SupportedEVMChain.ZeroNetwork,[s.CHAIN_IDS.BERACHAIN.toLowerCase()]:r.SupportedEVMChain.Berachain,"0x138c5":r.SupportedEVMChain.BerachainBartio,[s.CHAIN_IDS.INK.toLowerCase()]:r.SupportedEVMChain.Ink,[s.CHAIN_IDS.INK_SEPOLIA.toLowerCase()]:r.SupportedEVMChain.InkSepolia,"0xab5":r.SupportedEVMChain.Abstract,"0x2b74":r.SupportedEVMChain.AbstractTestnet,"0x74c":r.SupportedEVMChain.Soneium,[s.CHAIN_IDS.UNICHAIN.toLowerCase()]:r.SupportedEVMChain.Unichain,[s.CHAIN_IDS.SEI.toLowerCase()]:r.SupportedEVMChain.Sei,[s.CHAIN_IDS.FLOW.toLowerCase()]:r.SupportedEVMChain.FlowEvm};function c(e){return"string"==typeof e&&e?o[e.toLowerCase()]:undefined}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/trust-signals-util.ts"}]],[],{});